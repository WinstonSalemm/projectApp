<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ProjectApp.Client.Maui.Views.ProductSelectPage"
             Title="POJ PRO - Оформление продажи"
             BackgroundColor="{DynamicResource Color.Background}">
  <Grid ColumnDefinitions="2*,*" ColumnSpacing="16" Padding="16">
    
    <!-- ЛЕВАЯ ПАНЕЛЬ: Каталог товаров -->
    <Grid Grid.Column="0" RowDefinitions="Auto,Auto,*" RowSpacing="16">
      <!-- Поиск и Категория -->
      <Grid Grid.Row="0" RowDefinitions="Auto,Auto" RowSpacing="12">
        <!-- Выбор категории -->
        <Border Grid.Row="0" 
                StrokeThickness="0" 
                BackgroundColor="{DynamicResource Color.Surface}" 
                Padding="0" 
                StrokeShape="RoundRectangle 8">
          <Picker x:Name="CategoryPicker"
                  Title="Выберите категорию..." 
                  ItemsSource="{Binding Categories}"
                  SelectedItem="{Binding SelectedCategory}"
                  FontSize="19"
                  BackgroundColor="Transparent"
                  TextColor="{DynamicResource Color.Text.Primary}"
                  TitleColor="{DynamicResource Color.Text.Secondary}"
                  HeightRequest="70"
                  VerticalOptions="Center"
                  Margin="12,0"
                  SelectedIndexChanged="OnCategoryChanged"/>
        </Border>
        
        <!-- Поиск -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="12">
          <Entry Grid.Column="0" Placeholder="Поиск товаров..." Text="{Binding Query}" ReturnCommand="{Binding SearchAsyncCommand}" BackgroundColor="{DynamicResource Color.Surface}" TextColor="{DynamicResource Color.Text.Primary}" PlaceholderColor="{DynamicResource Color.Text.Secondary}" HeightRequest="56" FontSize="18"/>
          <Button Grid.Column="1" Text="Поиск" Command="{Binding SearchAsyncCommand}" WidthRequest="130" HeightRequest="56" FontSize="17"/>
        </Grid>
      </Grid>

      <!-- Удаляем старую строку категорий -->
      <BoxView Grid.Row="1" IsVisible="False"/>

      <!-- Товары -->
      <CollectionView Grid.Row="2" ItemsSource="{Binding Results}" SelectionMode="None">
        <CollectionView.ItemsLayout>
          <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="12" VerticalItemSpacing="12"/>
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 8">
              <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                <Label Grid.Row="0" Text="{Binding Name}" FontSize="17" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2" TextColor="{DynamicResource Color.Text.Primary}"/>
                <Label Grid.Row="1" Text="{Binding Sku}" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}"/>
                <Label Grid.Row="2" Text="{Binding TotalQty, StringFormat='📦 {0:N0} шт'}" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" Margin="0,4,0,0"/>
                <Button Grid.Row="3" Text="Добавить" CommandParameter="{Binding .}" Clicked="OnAddToCart" HeightRequest="44" FontSize="15" Margin="0,8,0,0" Padding="0"/>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="32" Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="🔍" FontSize="48" HorizontalTextAlignment="Center"/>
            <Label Text="Товары не найдены" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>
      </CollectionView>
    </Grid>
    
    <!-- ПРАВАЯ ПАНЕЛЬ: Корзина -->
    <Border Grid.Column="1" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
      <Grid RowDefinitions="Auto,*,Auto,Auto,Auto">
        <Label Grid.Row="0" Text="🛒 Корзина" FontSize="20" FontAttributes="Bold" Margin="0,0,0,16"/>
        
        <!-- Список товаров в корзине -->
        <ScrollView Grid.Row="1">
          <VerticalStackLayout BindableLayout.ItemsSource="{Binding CartItems}" Spacing="12">
            <BindableLayout.EmptyView>
              <Label Text="Корзина пуста" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" HorizontalTextAlignment="Center" Margin="0,32,0,0"/>
            </BindableLayout.EmptyView>
            <BindableLayout.ItemTemplate>
              <DataTemplate>
                <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" Padding="12" StrokeShape="RoundRectangle 6" BackgroundColor="{DynamicResource Color.Background}">
                  <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                    <Label Grid.Row="0" Text="{Binding Name}" FontSize="14" FontAttributes="Bold" LineBreakMode="WordWrap"/>
                    <Label Grid.Row="1" Text="{Binding Sku}" FontSize="11" TextColor="{DynamicResource Color.Text.Secondary}"/>
                    
                    <!-- Цена и количество -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="8">
                      <VerticalStackLayout Grid.Column="0" Spacing="6">
                        <Label Text="Цена" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding UnitPrice}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                      <VerticalStackLayout Grid.Column="1" Spacing="6">
                        <Label Text="Кол-во" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding Qty}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                    </Grid>
                    
                    <!-- Итого и удалить -->
                    <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                      <Label Grid.Column="0" Text="{Binding Total, StringFormat='Итого: {0:N0} сум'}" FontSize="14" FontAttributes="Bold" VerticalTextAlignment="Center" TextColor="{DynamicResource Color.Text.Primary}"/>
                      <Button Grid.Column="1" Text="❌" FontSize="14" WidthRequest="36" HeightRequest="36" Padding="0" CommandParameter="{Binding .}" Clicked="OnRemoveFromCart"/>
                    </Grid>
                  </Grid>
                </Border>
              </DataTemplate>
            </BindableLayout.ItemTemplate>
          </VerticalStackLayout>
        </ScrollView>
        
        <!-- Итого -->
        <Border Grid.Row="2" StrokeThickness="0" BackgroundColor="{DynamicResource Color.Primary}" Padding="16" Margin="0,16,0,0" StrokeShape="RoundRectangle 8">
          <Label Text="{Binding CartTotal, StringFormat='Итого: {0:N0} сум'}" FontSize="20" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>
        </Border>
        
        <!-- Выбор клиента -->
        <VerticalStackLayout Grid.Row="3" Spacing="8" Margin="0,16,0,0">
          <Label Text="Клиент (необязательно)" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Background}" Padding="14" StrokeShape="RoundRectangle 8">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnSelectClientClicked"/>
            </Border.GestureRecognizers>
            <Label Text="{Binding SelectedClientName}" FontSize="15" TextColor="{DynamicResource Color.Text.Primary}" VerticalTextAlignment="Center"/>
          </Border>
        </VerticalStackLayout>
        
        <!-- Кнопка оформления -->
        <Button Grid.Row="4" Text="Оформить продажу" Command="{Binding CheckoutCommand}" HeightRequest="52" FontSize="17" FontAttributes="Bold" Margin="0,12,0,0"/>
      </Grid>
    </Border>
  </Grid>
</ContentPage>
