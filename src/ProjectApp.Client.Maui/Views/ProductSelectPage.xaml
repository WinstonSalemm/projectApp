<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ProjectApp.Client.Maui.Views.ProductSelectPage"
             x:Name="Root"
             Title="POJ PRO - ÐžÑ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸"
             BackgroundColor="{DynamicResource Color.Background}">
  <Grid ColumnDefinitions="2*,*" ColumnSpacing="16" Padding="16">
    
    <!-- Ð›Ð•Ð’ÐÐ¯ ÐŸÐÐÐ•Ð›Ð¬: ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² -->
    <Grid Grid.Column="0" RowDefinitions="Auto,Auto,*" RowSpacing="16">
      <!-- ÐŸÐ¾Ð¸ÑÐº Ð¸ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ -->
      <Grid Grid.Row="0" RowDefinitions="Auto,Auto" RowSpacing="12">
        <!-- Ð’Ñ‹Ð±Ð¾Ñ€ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ -->
        <Border Grid.Row="0" 
                StrokeThickness="0" 
                BackgroundColor="{DynamicResource Color.Surface}" 
                Padding="0" 
                StrokeShape="RoundRectangle 8">
          <Picker x:Name="CategoryPicker"
                  Title="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ..." 
                  ItemsSource="{Binding Categories}"
                  SelectedItem="{Binding SelectedCategory}"
                  FontSize="19"
                  BackgroundColor="Transparent"
                  TextColor="{DynamicResource Color.Text.Primary}"
                  TitleColor="{DynamicResource Color.Text.Secondary}"
                  HeightRequest="70"
                  VerticalOptions="Center"
                  Margin="12,0"
                  SelectedIndexChanged="OnCategoryChanged"/>
        </Border>
        
        <!-- ÐŸÐ¾Ð¸ÑÐº -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="12">
          <Entry Grid.Column="0" Placeholder="ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²..." Text="{Binding Query}" ReturnCommand="{Binding SearchAsyncCommand}" BackgroundColor="{DynamicResource Color.Surface}" TextColor="{DynamicResource Color.Text.Primary}" PlaceholderColor="{DynamicResource Color.Text.Secondary}" HeightRequest="56" FontSize="18"/>
          <Button Grid.Column="1" Text="ÐŸÐ¾Ð¸ÑÐº" Command="{Binding SearchAsyncCommand}" WidthRequest="130" HeightRequest="56" FontSize="17" Style="{StaticResource Button.Primary}"/>
        </Grid>
      </Grid>

      <!-- Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ -->
      <BoxView Grid.Row="1" IsVisible="False"/>

      <!-- Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ -->
      <CollectionView Grid.Row="2" ItemsSource="{Binding Results}" SelectionMode="None">
        <CollectionView.ItemsLayout>
          <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="12" VerticalItemSpacing="12"/>
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 8">
              <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                <Label Grid.Row="0" Text="{Binding Name}" FontSize="17" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2" TextColor="{DynamicResource Color.Text.Primary}"/>
                <Label Grid.Row="1" Text="{Binding Sku}" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}"/>
                <Label Grid.Row="2" Text="{Binding TotalQty, StringFormat='ðŸ“¦ {0:N0} ÑˆÑ‚'}" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" Margin="0,4,0,0"/>
                <Grid Grid.Row="3" ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,8,0,0">
                  <Button Grid.Column="0" Text="Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ" CommandParameter="{Binding .}" Clicked="OnPickClicked" HeightRequest="44" FontSize="15" Padding="0" IsVisible="{Binding Source={x:Reference Root}, Path=IsPicker}" Style="{StaticResource Button.Secondary}"/>
                  <Button Grid.Column="1" Text="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ" CommandParameter="{Binding .}" Clicked="OnAddToCart" HeightRequest="44" FontSize="15" Padding="0" IsVisible="{Binding Source={x:Reference Root}, Path=IsPicker, Converter={StaticResource InverseBoolConverter}}" Style="{StaticResource CtaPrimary}"/>
                </Grid>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="32" Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="ðŸ”" FontSize="48" HorizontalTextAlignment="Center"/>
            <Label Text="Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>
      </CollectionView>
    </Grid>
    
    <!-- ÐŸÐ ÐÐ’ÐÐ¯ ÐŸÐÐÐ•Ð›Ð¬: ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° -->
    <Border Grid.Column="1" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12" IsVisible="{Binding Source={x:Reference Root}, Path=IsPicker, Converter={StaticResource InverseBoolConverter}}">
      <Grid RowDefinitions="Auto,*,Auto,Auto,Auto,Auto">
        <Label Grid.Row="0" Text="ðŸ›’ ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð°" FontSize="20" FontAttributes="Bold" Margin="0,0,0,16"/>
        
        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ -->
        <ScrollView Grid.Row="1" VerticalScrollBarVisibility="Always">
          <VerticalStackLayout BindableLayout.ItemsSource="{Binding CartItems}" Spacing="12">
            <BindableLayout.EmptyView>
              <Label Text="ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" HorizontalTextAlignment="Center" Margin="0,32,0,0"/>
            </BindableLayout.EmptyView>
            <BindableLayout.ItemTemplate>
              <DataTemplate>
                <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" Padding="12" StrokeShape="RoundRectangle 6" BackgroundColor="{DynamicResource Color.Background}">
                  <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                    <Label Grid.Row="0" Text="{Binding Name}" FontSize="14" FontAttributes="Bold" LineBreakMode="WordWrap"/>
                    <Label Grid.Row="1" Text="{Binding Sku}" FontSize="11" TextColor="{DynamicResource Color.Text.Secondary}"/>
                    
                    <!-- Ð¦ÐµÐ½Ð° Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="8">
                      <VerticalStackLayout Grid.Column="0" Spacing="6">
                        <Label Text="Ð¦ÐµÐ½Ð°" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding UnitPrice}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                      <VerticalStackLayout Grid.Column="1" Spacing="6">
                        <Label Text="ÐšÐ¾Ð»-Ð²Ð¾" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding Qty}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                    </Grid>
                    
                    <!-- Ð˜Ñ‚Ð¾Ð³Ð¾ Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ -->
                    <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                      <Label Grid.Column="0" Text="{Binding Total, StringFormat='Ð˜Ñ‚Ð¾Ð³Ð¾: {0:N0} ÑÑƒÐ¼'}" FontSize="14" FontAttributes="Bold" VerticalTextAlignment="Center" TextColor="{DynamicResource Color.Text.Primary}"/>
                      <Button Grid.Column="1" Text="âŒ" FontSize="14" WidthRequest="36" HeightRequest="36" Padding="0" CommandParameter="{Binding .}" Clicked="OnRemoveFromCart"/>
                    </Grid>
                  </Grid>
                </Border>
              </DataTemplate>
            </BindableLayout.ItemTemplate>
          </VerticalStackLayout>
        </ScrollView>
        
        <!-- Ð˜Ñ‚Ð¾Ð³Ð¾ -->
        <Border Grid.Row="2" StrokeThickness="0" BackgroundColor="{DynamicResource Color.Primary}" Padding="16" Margin="0,16,0,0" StrokeShape="RoundRectangle 8">
          <Label Text="{Binding CartTotal, StringFormat='Ð˜Ñ‚Ð¾Ð³Ð¾: {0:N0} ÑÑƒÐ¼'}" FontSize="20" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>
        </Border>
        
        <!-- Ð’Ñ‹Ð±Ð¾Ñ€ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° -->
        <VerticalStackLayout Grid.Row="3" Spacing="8" Margin="0,16,0,0">
          <Label Text="ÐšÐ»Ð¸ÐµÐ½Ñ‚ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Background}" Padding="14" StrokeShape="RoundRectangle 8">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnSelectClientClicked"/>
            </Border.GestureRecognizers>
            <Label Text="{Binding SelectedClientName}" FontSize="15" TextColor="{DynamicResource Color.Text.Primary}" VerticalTextAlignment="Center"/>
          </Border>
        </VerticalStackLayout>

        <!-- ÐŸÐ°Ñ€Ñ‚Ð½ÐµÑ€ Ð¸ ÑÑ‚Ð°Ð²ÐºÐ° ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¸ -->
        <VerticalStackLayout Grid.Row="4" Spacing="8" Margin="0,8,0,0">
          <Label Text="ÐŸÐ°Ñ€Ñ‚Ð½ÐµÑ€ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Background}" Padding="14" StrokeShape="RoundRectangle 8">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnSelectCommissionAgentClicked"/>
            </Border.GestureRecognizers>
            <Label Text="{Binding CommissionAgentName}" FontSize="15" TextColor="{DynamicResource Color.Text.Primary}" VerticalTextAlignment="Center"/>
          </Border>
          <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
            <Label Grid.Column="0" Text="Ð¡Ñ‚Ð°Ð²ÐºÐ°, %" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" VerticalTextAlignment="Center"/>
            <Entry Grid.Column="1" Keyboard="Numeric" Text="{Binding CommissionRate}" Placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 5" HeightRequest="44"/>
          </Grid>
        </VerticalStackLayout>

        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ -->
        <Button Grid.Row="5" Text="ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ñƒ" Command="{Binding CheckoutCommand}" HeightRequest="52" FontSize="17" FontAttributes="Bold" Margin="0,12,0,0" Style="{StaticResource CtaPrimary}"/>
      </Grid>
    </Border>
  </Grid>
</ContentPage>
