<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ProjectApp.Client.Maui.Views.ProductSelectPage"
             Title="ÐžÑ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸"
             BackgroundColor="{DynamicResource Color.Background}">
  <Grid ColumnDefinitions="2*,*" ColumnSpacing="16" Padding="16">
    
    <!-- Ð›Ð•Ð’ÐÐ¯ ÐŸÐÐÐ•Ð›Ð¬: ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² -->
    <Grid Grid.Column="0" RowDefinitions="Auto,Auto,*" RowSpacing="16">
      <!-- ÐŸÐ¾Ð¸ÑÐº -->
      <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
        <Entry Grid.Column="0" Placeholder="ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²..." Text="{Binding Query}" ReturnCommand="{Binding SearchAsyncCommand}" BackgroundColor="{DynamicResource Color.Surface}" TextColor="{DynamicResource Color.Text.Primary}" PlaceholderColor="{DynamicResource Color.Text.Secondary}" HeightRequest="48" FontSize="16"/>
        <Button Grid.Column="1" Text="ÐŸÐ¾Ð¸ÑÐº" Command="{Binding SearchAsyncCommand}" WidthRequest="120" HeightRequest="48" FontSize="16"/>
      </Grid>

      <!-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ -->
      <ScrollView Grid.Row="1" Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
        <HorizontalStackLayout Spacing="12">
          <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð’ÑÐµ" -->
          <Border StrokeThickness="0" BackgroundColor="{DynamicResource Color.Primary}" Padding="16,8" StrokeShape="RoundRectangle 20">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnAllCategoriesClicked"/>
            </Border.GestureRecognizers>
            <Label Text="Ð’ÑÐµ" TextColor="White" FontSize="14" FontAttributes="Bold"/>
          </Border>
          
          <!-- ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ -->
          <HorizontalStackLayout Spacing="12" BindableLayout.ItemsSource="{Binding Categories}">
            <BindableLayout.ItemTemplate>
              <DataTemplate>
                <Border StrokeThickness="0" BackgroundColor="{DynamicResource Color.Primary}" Padding="16,8" StrokeShape="RoundRectangle 20">
                  <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SearchAsyncCommand}" CommandParameter="{Binding .}"/>
                  </Border.GestureRecognizers>
                  <Label Text="{Binding .}" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                </Border>
              </DataTemplate>
            </BindableLayout.ItemTemplate>
          </HorizontalStackLayout>
        </HorizontalStackLayout>
      </ScrollView>

      <!-- Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ -->
      <CollectionView Grid.Row="2" ItemsSource="{Binding Results}" SelectionMode="None">
        <CollectionView.ItemsLayout>
          <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="12" VerticalItemSpacing="12"/>
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="12" StrokeShape="RoundRectangle 8">
              <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
                <Label Grid.Row="0" Text="{Binding Name}" FontSize="16" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2"/>
                <Label Grid.Row="1" Text="{Binding Sku}" FontSize="12" TextColor="{DynamicResource Color.Text.Secondary}"/>
                <Label Grid.Row="2" Text="{Binding TotalQty, StringFormat='ðŸ“¦ {0:N0} ÑˆÑ‚'}" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" Margin="0,4,0,0"/>
                <Button Grid.Row="3" Text="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ" CommandParameter="{Binding .}" Clicked="OnAddToCart" HeightRequest="36" FontSize="14" Margin="0,6,0,0"/>
              </Grid>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        <CollectionView.EmptyView>
          <VerticalStackLayout Padding="32" Spacing="12" HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="ðŸ”" FontSize="48" HorizontalTextAlignment="Center"/>
            <Label Text="Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
          </VerticalStackLayout>
        </CollectionView.EmptyView>
      </CollectionView>
    </Grid>
    
    <!-- ÐŸÐ ÐÐ’ÐÐ¯ ÐŸÐÐÐ•Ð›Ð¬: ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° -->
    <Border Grid.Column="1" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
      <Grid RowDefinitions="Auto,*,Auto,Auto,Auto">
        <Label Grid.Row="0" Text="ðŸ›’ ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð°" FontSize="20" FontAttributes="Bold" Margin="0,0,0,16"/>
        
        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ -->
        <ScrollView Grid.Row="1">
          <VerticalStackLayout BindableLayout.ItemsSource="{Binding CartItems}" Spacing="12">
            <BindableLayout.EmptyView>
              <Label Text="ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" HorizontalTextAlignment="Center" Margin="0,32,0,0"/>
            </BindableLayout.EmptyView>
            <BindableLayout.ItemTemplate>
              <DataTemplate>
                <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" Padding="12" StrokeShape="RoundRectangle 6" BackgroundColor="{DynamicResource Color.Background}">
                  <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                    <Label Grid.Row="0" Text="{Binding Name}" FontSize="14" FontAttributes="Bold" LineBreakMode="WordWrap"/>
                    <Label Grid.Row="1" Text="{Binding Sku}" FontSize="11" TextColor="{DynamicResource Color.Text.Secondary}"/>
                    
                    <!-- Ð¦ÐµÐ½Ð° Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="8">
                      <VerticalStackLayout Grid.Column="0" Spacing="6">
                        <Label Text="Ð¦ÐµÐ½Ð°" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding UnitPrice}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                      <VerticalStackLayout Grid.Column="1" Spacing="6">
                        <Label Text="ÐšÐ¾Ð»-Ð²Ð¾" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}" FontAttributes="Bold"/>
                        <Entry Text="{Binding Qty}" Keyboard="Numeric" FontSize="18" HeightRequest="44"/>
                      </VerticalStackLayout>
                    </Grid>
                    
                    <!-- Ð˜Ñ‚Ð¾Ð³Ð¾ Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ -->
                    <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                      <Label Grid.Column="0" Text="{Binding Total, StringFormat='Ð˜Ñ‚Ð¾Ð³Ð¾: {0:N0} ÑÑƒÐ¼'}" FontSize="13" FontAttributes="Bold" VerticalTextAlignment="Center"/>
                      <Button Grid.Column="1" Text="âŒ" FontSize="12" WidthRequest="32" HeightRequest="32" Padding="0" CommandParameter="{Binding .}" Clicked="OnRemoveFromCart"/>
                    </Grid>
                  </Grid>
                </Border>
              </DataTemplate>
            </BindableLayout.ItemTemplate>
          </VerticalStackLayout>
        </ScrollView>
        
        <!-- Ð˜Ñ‚Ð¾Ð³Ð¾ -->
        <Border Grid.Row="2" StrokeThickness="0" BackgroundColor="{DynamicResource Color.Primary}" Padding="12" Margin="0,16,0,0" StrokeShape="RoundRectangle 6">
          <Label Text="{Binding CartTotal, StringFormat='Ð˜Ñ‚Ð¾Ð³Ð¾: {0:N0} ÑÑƒÐ¼'}" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>
        </Border>
        
        <!-- Ð’Ñ‹Ð±Ð¾Ñ€ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° -->
        <VerticalStackLayout Grid.Row="3" Spacing="8" Margin="0,16,0,0">
          <Label Text="ÐšÐ»Ð¸ÐµÐ½Ñ‚ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}"/>
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Background}" Padding="12" StrokeShape="RoundRectangle 6">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnSelectClientClicked"/>
            </Border.GestureRecognizers>
            <Label Text="{Binding SelectedClientName}" FontSize="14" TextColor="{DynamicResource Color.Text.Primary}" VerticalTextAlignment="Center"/>
          </Border>
        </VerticalStackLayout>
        
        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ -->
        <Button Grid.Row="4" Text="ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ñƒ" Command="{Binding CheckoutCommand}" HeightRequest="48" FontSize="16" FontAttributes="Bold" Margin="0,12,0,0"/>
      </Grid>
    </Border>
  </Grid>
</ContentPage>
