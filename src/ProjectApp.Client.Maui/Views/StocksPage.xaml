<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.StocksPage"
             x:Name="Root"
             Title="Ð¡ÐºÐ»Ð°Ð´ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐÐ´Ð¼Ð¸Ð½)"
             BackgroundColor="{DynamicResource Color.Background}">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ"
                     Command="{Binding RefreshCommand}"
                     IconImageSource="{StaticResource IconRefresh}" />
        <ToolbarItem Text="âž• ÐÐ° ÑÐºÐ»Ð°Ð´"
                     Clicked="OnAddToStockClicked" />
        <ToolbarItem Text="ðŸ—‘ï¸ Ð‘Ñ€Ð°Ðº"
                     Clicked="OnDefectivesClicked" />
        <ToolbarItem Text="ðŸ”¥ ÐŸÐµÑ€ÐµÐ·Ð°Ñ€ÑÐ´ÐºÐ°"
                     Clicked="OnRefillsClicked" />
    </ContentPage.ToolbarItems>
    <Grid Padding="24"
          RowDefinitions="*,Auto"
          RowSpacing="16">
        <!-- Summary mode (header + list share one scroll) -->
        <CollectionView Grid.Row="0"
                        ItemsSource="{Binding Items}"
                        IsVisible="{Binding ShowBatches, Converter={StaticResource InverseBoolConverter}}"
                        Margin="0,0,12,0">
            <CollectionView.EmptyView>
                <VerticalStackLayout Padding="12"
                                     Spacing="6">
                    <Label Text="ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Color.Text.Secondary}" />
                    <Label Text="Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¸Ð»Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ"
                           FontSize="12"
                           TextColor="{DynamicResource Color.Text.Secondary}" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.Header>
                <VerticalStackLayout Spacing="16"
                                     Padding="0,0,0,16">
                    <!-- Search Section -->
                    <Frame Padding="16"
                           CornerRadius="12"
                           BackgroundColor="{DynamicResource Color.Surface}"
                           BorderColor="{DynamicResource Color.Border}"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Color.Text.Primary}" />
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="12">
                                <Frame Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <Entry Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ SKU Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°"
                                           Text="{Binding Query}"
                                           BackgroundColor="Transparent"
                                           FontSize="14" />
                                </Frame>
                                <Frame Grid.Column="1"
                                       Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <Picker WidthRequest="200"
                                            ItemsSource="{Binding Categories}"
                                            SelectedItem="{Binding SelectedCategory}"
                                            BackgroundColor="Transparent"
                                            FontSize="14" />
                                </Frame>
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="12">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸ“‹"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¸"
                                           FontSize="13"
                                           VerticalOptions="Center"
                                           TextColor="{DynamicResource Color.Text.Secondary}" />
                                    <Switch IsToggled="{Binding ShowBatches}"
                                            VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <Button Grid.Column="2"
                                        Text="ðŸ” ÐÐ°Ð¹Ñ‚Ð¸"
                                        Command="{Binding RefreshCommand}"
                                        Style="{StaticResource Button.Primary}"
                                        WidthRequest="120" />
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Style="{StaticResource CardFrame}"
                           Margin="0,0,0,12">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnEditProductTapped" />
                        </Frame.GestureRecognizers>
                        <Grid RowDefinitions="Auto,Auto,Auto"
                              ColumnDefinitions="Auto,*"
                              RowSpacing="12"
                              ColumnSpacing="16">
                            <!-- Product Icon -->
                            <Frame Grid.RowSpan="3"
                                   WidthRequest="60"
                                   HeightRequest="60"
                                   CornerRadius="12"
                                   Padding="0"
                                   BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                   BorderColor="{DynamicResource Color.Border}"
                                   HasShadow="False">
                                <Label Text="ðŸ“¦"
                                       FontSize="32"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            <!-- Product Info -->
                            <VerticalStackLayout Grid.Column="1"
                                                 Spacing="4">
                                <Label Text="{Binding Name}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource Color.Text.Primary}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding Sku}"
                                           FontSize="13"
                                           TextColor="{DynamicResource Color.Text.Secondary}"
                                           FontFamily="InterSemiBold" />
                                    <BoxView WidthRequest="1"
                                             HeightRequest="14"
                                             Color="{DynamicResource Color.Border}"
                                             VerticalOptions="Center" />
                                    <Label Text="{Binding Category}"
                                           FontSize="13"
                                           TextColor="{DynamicResource Color.Text.Tertiary}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                            <!-- Stock Badges -->
                            <Grid Grid.Row="1"
                                  Grid.Column="1"
                                  ColumnDefinitions="Auto,Auto,*"
                                  ColumnSpacing="8">
                                <Frame Grid.Column="0"
                                       Padding="12,6"
                                       CornerRadius="8"
                                       HasShadow="False"
                                       BackgroundColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                                       BorderColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="ðŸ“"
                                               FontSize="13" />
                                        <Label Text="{Binding Nd40Qty, StringFormat='ND-40: {0:N0}'}"
                                               FontSize="13"
                                               FontFamily="InterSemiBold"
                                               TextColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}" />
                                    </HorizontalStackLayout>
                                </Frame>
                                <Frame Grid.Column="1"
                                       Padding="12,6"
                                       CornerRadius="8"
                                       HasShadow="False"
                                       BackgroundColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                                       BorderColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="ðŸ­"
                                               FontSize="13" />
                                        <Label Text="{Binding Im40Qty, StringFormat='IM-40: {0:N0}'}"
                                               FontSize="13"
                                               FontFamily="InterSemiBold"
                                               TextColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}" />
                                    </HorizontalStackLayout>
                                </Frame>
                            </Grid>
                            <!-- Total Badge (larger, prominent) -->
                            <Frame Grid.Row="2"
                                   Grid.Column="1"
                                   Padding="14,8"
                                   CornerRadius="10"
                                   HasShadow="True"
                                   BackgroundColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                                   BorderColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸ“Š"
                                           FontSize="16" />
                                    <Label Text="Ð˜Ð¢ÐžÐ“Ðž:"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"
                                           TextColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}" />
                                    <Label Text="{Binding TotalQty, StringFormat='{0:N0} ÑˆÑ‚.'}"
                                           FontSize="18"
                                           FontFamily="InterBold"
                                           VerticalOptions="Center"
                                           TextColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}" />
                                </HorizontalStackLayout>
                            </Frame>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        <!-- Batches mode -->
        <CollectionView Grid.Row="0"
                        ItemsSource="{Binding BatchItems}"
                        IsVisible="{Binding ShowBatches}"
                        Margin="0,0,12,0">
            <CollectionView.EmptyView>
                <VerticalStackLayout Padding="12"
                                     Spacing="6">
                    <Label Text="ÐÐµÑ‚ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¹"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Color.Text.Secondary}" />
                    <Label Text="ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¸Ð»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ"
                           FontSize="12"
                           TextColor="{DynamicResource Color.Text.Secondary}" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.Header>
                <VerticalStackLayout Spacing="16"
                                     Padding="0,0,0,16">
                    <!-- Search Section -->
                    <Frame Padding="16"
                           CornerRadius="12"
                           BackgroundColor="{DynamicResource Color.Surface}"
                           BorderColor="{DynamicResource Color.Border}"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Color.Text.Primary}" />
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="12">
                                <Frame Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <Entry Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ SKU Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°"
                                           Text="{Binding Query}"
                                           BackgroundColor="Transparent"
                                           FontSize="14" />
                                </Frame>
                                <Frame Grid.Column="1"
                                       Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <Picker WidthRequest="200"
                                            ItemsSource="{Binding Categories}"
                                            SelectedItem="{Binding SelectedCategory}"
                                            BackgroundColor="Transparent"
                                            FontSize="14" />
                                </Frame>
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="12">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸ“‹"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¸"
                                           FontSize="13"
                                           VerticalOptions="Center"
                                           TextColor="{DynamicResource Color.Text.Secondary}" />
                                    <Switch IsToggled="{Binding ShowBatches}"
                                            VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <Button Grid.Column="2"
                                        Text="ðŸ” ÐÐ°Ð¹Ñ‚Ð¸"
                                        Command="{Binding RefreshCommand}"
                                        Style="{StaticResource Button.Primary}"
                                        WidthRequest="120" />
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Style="{StaticResource CardFrame}"
                           Margin="0,0,0,12">
                        <Grid RowDefinitions="Auto,Auto"
                              ColumnDefinitions="Auto,*,Auto"
                              RowSpacing="12"
                              ColumnSpacing="16">
                            <!-- Batch Icon -->
                            <Frame Grid.RowSpan="2"
                                   WidthRequest="50"
                                   HeightRequest="50"
                                   CornerRadius="10"
                                   Padding="0"
                                   BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                   BorderColor="{DynamicResource Color.Border}"
                                   HasShadow="False">
                                <Label Text="ðŸ“‹"
                                       FontSize="28"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Frame>
                            <!-- Product Info -->
                            <VerticalStackLayout Grid.Column="1"
                                                 Spacing="4">
                                <Label Text="{Binding Name}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource Color.Text.Primary}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding Sku}"
                                           FontSize="12"
                                           TextColor="{DynamicResource Color.Text.Secondary}"
                                           FontFamily="InterSemiBold" />
                                    <BoxView WidthRequest="1"
                                             HeightRequest="12"
                                             Color="{DynamicResource Color.Border}"
                                             VerticalOptions="Center" />
                                    <Label Text="{Binding Category}"
                                           FontSize="12"
                                           TextColor="{DynamicResource Color.Text.Tertiary}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                            <!-- Register Badge -->
                            <Frame Grid.Column="2"
                                   Style="{StaticResource BadgeFrame}">
                                <Label Text="{Binding Register}"
                                       FontSize="12"
                                       FontFamily="InterBold" />
                            </Frame>
                            <!-- Quantity and Cost -->
                            <Grid Grid.Row="1"
                                  Grid.Column="1"
                                  Grid.ColumnSpan="2"
                                  ColumnDefinitions="*,Auto"
                                  ColumnSpacing="16">
                                <Frame Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="ðŸ“¦"
                                               FontSize="14" />
                                        <Label Text="ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾:"
                                               FontSize="12"
                                               TextColor="{DynamicResource Color.Text.Secondary}"
                                               VerticalOptions="Center" />
                                        <Label Text="{Binding Qty, StringFormat='{0:N3}'}"
                                               FontSize="16"
                                               FontFamily="InterBold"
                                               TextColor="{DynamicResource Color.Text.Primary}"
                                               VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Frame>
                                <Frame Grid.Column="1"
                                       Padding="12,8"
                                       CornerRadius="8"
                                       BackgroundColor="{DynamicResource Color.Surface.Muted}"
                                       BorderColor="{DynamicResource Color.Border}"
                                       HasShadow="False">
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="ðŸ’°"
                                               FontSize="14" />
                                        <Label Text="{Binding UnitCost, Converter={StaticResource CurrencyConverter}}"
                                               FontSize="14"
                                               FontFamily="InterBold"
                                               TextColor="{DynamicResource Color.Text.Primary}"
                                               VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Frame>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        <Label Grid.Row="1"
               Text="{Binding StatusMessage}"
               TextColor="Red" />
    </Grid>
</ContentPage>