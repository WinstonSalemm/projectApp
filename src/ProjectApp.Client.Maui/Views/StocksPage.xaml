<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.StocksPage"
             x:Name="Root"
             Title="Склад (только Админ)">
  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>
  <ContentPage.ToolbarItems>
    <ToolbarItem Text="Обновить" Command="{Binding RefreshCommand}" />
  </ContentPage.ToolbarItems>
  <VerticalStackLayout Padding="12" Spacing="8">
    <Grid ColumnDefinitions="*,Auto,200" ColumnSpacing="8">
      <HorizontalStackLayout Grid.Column="0" Spacing="8">
        <Label Text="Поиск:" VerticalOptions="Center"/>
        <Entry Placeholder="SKU или название" Text="{Binding Query}"/>
      </HorizontalStackLayout>
      <Label Grid.Column="1" Text="Категория:" VerticalTextAlignment="Center"/>
      <Picker Grid.Column="2" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"/>
    </Grid>
    <HorizontalStackLayout Spacing="12">
      <Label Text="Показывать партии" VerticalTextAlignment="Center"/>
      <Switch IsToggled="{Binding ShowBatches}"/>
    </HorizontalStackLayout>
    <Button Text="Найти" Command="{Binding RefreshCommand}"/>

    <!-- Summary mode -->
    <CollectionView ItemsSource="{Binding Items}" IsVisible="{Binding ShowBatches, Converter={StaticResource InverseBoolConverter}}">
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="12" Padding="6">
            <VerticalStackLayout>
              <Label Text="{Binding Name}" FontAttributes="Bold"/>
              <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
              <Label Text="{Binding Category}" FontSize="12"/>
            </VerticalStackLayout>
            <Label Grid.Column="1" Text="{Binding Nd40Qty, StringFormat='ND-40: {0:F3}'}" VerticalTextAlignment="Center"/>
            <Label Grid.Column="2" Text="{Binding Im40Qty, StringFormat='IM-40: {0:F3}'}" VerticalTextAlignment="Center"/>
            <Label Grid.Column="3" Text="{Binding TotalQty, StringFormat='Итого: {0:F3}'}" FontAttributes="Bold" VerticalTextAlignment="Center"/>
          </Grid>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <!-- Batches mode -->
    <CollectionView ItemsSource="{Binding BatchItems}" IsVisible="{Binding ShowBatches}">
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="12" Padding="6">
            <VerticalStackLayout>
              <Label Text="{Binding Name}" FontAttributes="Bold"/>
              <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
              <Label Text="{Binding Category}" FontSize="12"/>
            </VerticalStackLayout>
            <Label Grid.Column="1" Text="{Binding Register}" VerticalTextAlignment="Center"/>
            <Label Grid.Column="2" Text="{Binding Code, StringFormat='Код: {0}'}" VerticalTextAlignment="Center"/>
            <Label Grid.Column="3" Text="{Binding Qty, StringFormat='Qty: {0:F3}'}" VerticalTextAlignment="Center"/>
            <Label Grid.Column="4" Text="{Binding UnitCost, StringFormat='Себестоимость: {0:F2}'}" VerticalTextAlignment="Center"/>
          </Grid>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <Label Text="{Binding StatusMessage}" TextColor="Red"/>
  </VerticalStackLayout>
</ContentPage>
