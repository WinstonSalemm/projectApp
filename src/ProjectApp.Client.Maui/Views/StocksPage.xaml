<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.StocksPage"
             x:Name="Root"
             Title="Ð¡ÐºÐ»Ð°Ð´ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐÐ´Ð¼Ð¸Ð½)">
  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>
  <ContentPage.ToolbarItems>
    <ToolbarItem Text="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Command="{Binding RefreshCommand}" IconImageSource="{StaticResource IconRefresh}" />
    <ToolbarItem Text="ðŸ—‘ï¸ Ð‘Ñ€Ð°Ðº" Clicked="OnDefectivesClicked" />
    <ToolbarItem Text="ðŸ”¥ ÐŸÐµÑ€ÐµÐ·Ð°Ñ€ÑÐ´ÐºÐ°" Clicked="OnRefillsClicked" />
  </ContentPage.ToolbarItems>
  <Grid Padding="24" RowDefinitions="*,Auto" RowSpacing="16">
    <!-- Summary mode (header + list share one scroll) -->
    <CollectionView Grid.Row="0" ItemsSource="{Binding Items}" IsVisible="{Binding ShowBatches, Converter={StaticResource InverseBoolConverter}}">
      <CollectionView.EmptyView>
        <VerticalStackLayout Padding="12" Spacing="6">
          <Label Text="ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
          <Label Text="Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¸Ð»Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>
      <CollectionView.Header>
        <VerticalStackLayout Spacing="12" Padding="0,0,0,8">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Entry Grid.Column="0" Placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ SKU Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ" Text="{Binding Query}"/>
            <Picker Grid.Column="1" WidthRequest="220" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"/>
          </Grid>
          <HorizontalStackLayout Spacing="12">
            <Label Text="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¸" VerticalTextAlignment="Center"/>
            <Switch IsToggled="{Binding ShowBatches}"/>
            <Button Text="ÐÐ°Ð¹Ñ‚Ð¸" Command="{Binding RefreshCommand}" Style="{StaticResource OutlinedButton}"/>
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </CollectionView.Header>
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Style="{StaticResource CardFrame}">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*" RowSpacing="8">
              <VerticalStackLayout>
                <Label Text="{Binding Name}" FontAttributes="Bold"/>
                <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
                <Label Text="{Binding Category}" FontSize="12"/>
              </VerticalStackLayout>
              <HorizontalStackLayout Grid.Row="1" Spacing="8">
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding Nd40Qty, StringFormat='ND-40: {0:N0}'}" FontSize="11"
                         TextColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding Im40Qty, StringFormat='IM-40: {0:N0}'}" FontSize="11"
                         TextColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding TotalQty, StringFormat='Ð˜Ñ‚Ð¾Ð³Ð¾: {0:N0}'}" FontSize="11"
                         TextColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
              </HorizontalStackLayout>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <!-- Batches mode -->
    <CollectionView Grid.Row="0" ItemsSource="{Binding BatchItems}" IsVisible="{Binding ShowBatches}">
      <CollectionView.EmptyView>
        <VerticalStackLayout Padding="12" Spacing="6">
          <Label Text="ÐÐµÑ‚ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¹" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
          <Label Text="ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¸Ð»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>
      <CollectionView.Header>
        <VerticalStackLayout Spacing="12" Padding="0,0,0,8">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Entry Grid.Column="0" Placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ SKU Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ" Text="{Binding Query}"/>
            <Picker Grid.Column="1" WidthRequest="220" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"/>
          </Grid>
          <HorizontalStackLayout Spacing="12">
            <Label Text="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ñ‚Ð¸Ð¸" VerticalTextAlignment="Center"/>
            <Switch IsToggled="{Binding ShowBatches}"/>
            <Button Text="ÐÐ°Ð¹Ñ‚Ð¸" Command="{Binding RefreshCommand}" Style="{StaticResource OutlinedButton}"/>
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </CollectionView.Header>
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Style="{StaticResource CardFrame}">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="12">
              <VerticalStackLayout>
                <Label Text="{Binding Name}" FontAttributes="Bold"/>
                <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
                <Label Text="{Binding Category}" FontSize="12"/>
              </VerticalStackLayout>
              <Frame Grid.Column="1" Style="{StaticResource BadgeFrame}">
                <Label Text="{Binding Register}" FontSize="11"/>
              </Frame>
              <Label Grid.Column="2" Text="{Binding Qty, StringFormat='Qty: {0:N3}'}" VerticalTextAlignment="Center"/>
              <Label Grid.Column="3" Text="{Binding UnitCost, Converter={StaticResource CurrencyConverter}, StringFormat='Ð¡ÐµÐ±ÐµÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {0}'}" VerticalTextAlignment="Center"/>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <Label Grid.Row="1" Text="{Binding StatusMessage}" TextColor="Red"/>
  </Grid>
</ContentPage>


