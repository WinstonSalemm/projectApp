<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.StocksPage"
             x:Name="Root"
             Title="РЎРєР»Р°Рґ (С‚РѕР»СЊРєРѕ РђРґРјРёРЅ)">
  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>
  <ContentPage.ToolbarItems>
    <ToolbarItem Text="РћР±РЅРѕРІРёС‚СЊ" Command="{Binding RefreshCommand}" IconImageSource="{StaticResource IconRefresh}" />
  </ContentPage.ToolbarItems>
  <Grid Padding="24" RowDefinitions="*,Auto" RowSpacing="16">
    <!-- Summary mode (header + list share one scroll) -->
    <CollectionView Grid.Row="0" ItemsSource="{Binding Items}" IsVisible="{Binding ShowBatches, Converter={StaticResource InverseBoolConverter}}">
      <CollectionView.EmptyView>
        <VerticalStackLayout Padding="12" Spacing="6">
          <Label Text="РќРµС‚ РґР°РЅРЅС‹С…" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
          <Label Text="РР·РјРµРЅРёС‚Рµ Р·Р°РїСЂРѕСЃ РёР»Рё РєР°С‚РµРіРѕСЂРёСЋ" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>
      <CollectionView.Header>
        <VerticalStackLayout Spacing="12" Padding="0,0,0,8">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Entry Grid.Column="0" Placeholder="РџРѕРёСЃРє РїРѕ SKU РёР»Рё РЅР°Р·РІР°РЅРёСЋ" Text="{Binding Query}"/>
            <Picker Grid.Column="1" WidthRequest="220" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"/>
          </Grid>
          <HorizontalStackLayout Spacing="12">
            <Label Text="РџРѕРєР°Р·С‹РІР°С‚СЊ РїР°СЂС‚РёРё" VerticalTextAlignment="Center"/>
            <Switch IsToggled="{Binding ShowBatches}"/>
            <Button Text="РќР°Р№С‚Рё" Command="{Binding RefreshCommand}" Style="{StaticResource OutlinedButton}"/>
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </CollectionView.Header>
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Style="{StaticResource CardFrame}">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*" RowSpacing="8">
              <VerticalStackLayout>
                <Label Text="{Binding Name}" FontAttributes="Bold"/>
                <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
                <Label Text="{Binding Category}" FontSize="12"/>
              </VerticalStackLayout>
              <HorizontalStackLayout Grid.Row="1" Spacing="8">
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding Nd40Qty, StringFormat='ND-40: {0:N0}'}" FontSize="11"
                         TextColor="{Binding Nd40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding Im40Qty, StringFormat='IM-40: {0:N0}'}" FontSize="11"
                         TextColor="{Binding Im40Qty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
                <Frame Style="{StaticResource BadgeFrame}"
                       BackgroundColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=bg}"
                       BorderColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=border}">
                  <Label Text="{Binding TotalQty, StringFormat='РС‚РѕРіРѕ: {0:N0}'}" FontSize="11"
                         TextColor="{Binding TotalQty, Converter={StaticResource QtyToAvailabilityColorConverter}, ConverterParameter=text}"/>
                </Frame>
              </HorizontalStackLayout>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <!-- Batches mode -->
    <CollectionView Grid.Row="0" ItemsSource="{Binding BatchItems}" IsVisible="{Binding ShowBatches}">
      <CollectionView.EmptyView>
        <VerticalStackLayout Padding="12" Spacing="6">
          <Label Text="РќРµС‚ РїР°СЂС‚РёР№" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
          <Label Text="РџРѕРїСЂРѕР±СѓР№С‚Рµ РґСЂСѓРіРѕР№ С„РёР»СЊС‚СЂ РёР»Рё Р·Р°РїСЂРѕСЃ" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>
      <CollectionView.Header>
        <VerticalStackLayout Spacing="12" Padding="0,0,0,8">
          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
            <Entry Grid.Column="0" Placeholder="РџРѕРёСЃРє РїРѕ SKU РёР»Рё РЅР°Р·РІР°РЅРёСЋ" Text="{Binding Query}"/>
            <Picker Grid.Column="1" WidthRequest="220" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"/>
          </Grid>
          <HorizontalStackLayout Spacing="12">
            <Label Text="РџРѕРєР°Р·С‹РІР°С‚СЊ РїР°СЂС‚РёРё" VerticalTextAlignment="Center"/>
            <Switch IsToggled="{Binding ShowBatches}"/>
            <Button Text="РќР°Р№С‚Рё" Command="{Binding RefreshCommand}" Style="{StaticResource OutlinedButton}"/>
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </CollectionView.Header>
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Style="{StaticResource CardFrame}">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="12">
              <VerticalStackLayout>
                <Label Text="{Binding Name}" FontAttributes="Bold"/>
                <Label Text="{Binding Sku}" FontSize="12" TextColor="Gray"/>
                <Label Text="{Binding Category}" FontSize="12"/>
              </VerticalStackLayout>
              <Frame Grid.Column="1" Style="{StaticResource BadgeFrame}">
                <Label Text="{Binding Register}" FontSize="11"/>
              </Frame>
              <Label Grid.Column="2" Text="{Binding Qty, StringFormat='Qty: {0:N3}'}" VerticalTextAlignment="Center"/>
              <Label Grid.Column="3" Text="{Binding UnitCost, Converter={StaticResource CurrencyConverter}, StringFormat='РЎРµР±РµСЃС‚РѕРёРјРѕСЃС‚СЊ: {0}'}" VerticalTextAlignment="Center"/>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>

    <Label Grid.Row="1" Text="{Binding StatusMessage}" TextColor="Red"/>
  </Grid>
</ContentPage>


