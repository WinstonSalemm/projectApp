<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:models="clr-namespace:ProjectApp.Client.Maui.Models"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.QuickSalePage"
             x:Name="RootPage"
             x:DataType="viewModels:QuickSaleViewModel"
             Title="Быстрая продажа">
  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:PaymentTypeToRuConverter x:Key="PaymentTypeToRuConverter" />
      <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
      <converters:CurrencyConverter x:Key="CurrencyConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>

  <ContentPage.ToolbarItems>
    <ToolbarItem Text="Настройки" Clicked="OnSettingsClicked" IconImageSource="{StaticResource IconSettings}" />
  </ContentPage.ToolbarItems>

  <Grid RowDefinitions="Auto,*" Padding="24" RowSpacing="16">
    <Frame Grid.Row="0"
           BackgroundColor="#FFCC00"
           Padding="12"
           HasShadow="False"
           IsVisible="{Binding IsOffline}">
      <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
        <Label Text="Нет связи с сервером"
               FontAttributes="Bold"
               VerticalOptions="Center" />
        <Button Text="Повторить"
                Command="{Binding RetryCommand}"
                Style="{StaticResource Button.Secondary}" />
      </HorizontalStackLayout>
    </Frame>

    <Grid Grid.Row="1" ColumnDefinitions="2*,*" ColumnSpacing="24">
      <!-- Левая колонка: каталог -->
      <Grid RowDefinitions="Auto,Auto,*" RowSpacing="16">
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
          <Entry Placeholder="Поиск по названию или SKU"
                 Text="{Binding Query}"
                 ClearButtonVisibility="WhileEditing" />
          <Picker ItemsSource="{Binding Categories}"
                  SelectedItem="{Binding SelectedCategory}"
                  Title="Все категории"
                  WidthRequest="220" />
        </Grid>

        <Border Grid.Row="1" Style="{StaticResource Card.Container}">
          <VerticalStackLayout Spacing="4">
            <Label Text="Результаты поиска"
                   FontAttributes="Bold"
                   FontSize="{StaticResource Font.Size.H3}" />
            <Label Text="Добавьте товары в корзину кнопкой справа."
                   TextColor="{DynamicResource Color.Text.Secondary}" />
          </VerticalStackLayout>
        </Border>

        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding SearchResults}"
                        SelectionMode="None"
                        Margin="0,0,0,16">
          <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="viewModels:QuickSaleViewModel+QuickProductRow">
              <Border Style="{StaticResource Card.Container}">
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12">
                  <Label Grid.Row="0"
                         Grid.Column="0"
                         Text="{Binding Name}"
                         FontAttributes="Bold"
                         LineBreakMode="TailTruncation" />
                  <Label Grid.Row="1"
                         Grid.Column="0"
                         Text="{Binding Sku}"
                         TextColor="{DynamicResource Color.Text.Secondary}" />
                  <Label Grid.Row="2"
                         Grid.Column="0"
                         Text="{Binding Price, Converter={StaticResource CurrencyConverter}}"
                         FontAttributes="Bold" />
                  <Button Grid.Row="0"
                          Grid.Column="1"
                          Grid.RowSpan="3"
                          Text="Добавить"
                          Style="{StaticResource CtaPrimary}"
                          Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.AddToCartCommand}"
                          CommandParameter="{Binding .}" />
                </Grid>
              </Border>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>
      </Grid>

      <!-- Правая колонка: корзина -->
      <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto,Auto,Auto" RowSpacing="16">
        <Border Grid.Row="0" Style="{StaticResource Card.Container}">
          <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
            <Label Text="Тип оплаты:" FontAttributes="Bold" />
            <Label Text="{Binding SelectedPaymentType, Converter={StaticResource PaymentTypeToRuConverter}}" />
            <Button Text="Изменить"
                    Command="{Binding ChangePaymentTypeCommand}"
                    Style="{StaticResource Button.Tertiary}" />
          </HorizontalStackLayout>
        </Border>

        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Cart}"
                        SelectionMode="None">
          <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="models:CartItemModel">
              <Border Style="{StaticResource Card.Container}">
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12">
                  <Label Grid.Row="0" Grid.Column="0" Text="{Binding Name}" FontAttributes="Bold" />
                  <Label Grid.Row="1" Grid.Column="0" Text="{Binding UnitPrice, Converter={StaticResource CurrencyConverter}}" TextColor="{DynamicResource Color.Text.Secondary}" />
                  <StackLayout Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <Label Text="Количество:" VerticalOptions="Center" />
                    <Entry Text="{Binding Qty, Mode=TwoWay}" WidthRequest="80" Keyboard="Numeric" />
                    <Label Text="Цена:" VerticalOptions="Center" />
                    <Entry Text="{Binding UnitPrice, Mode=TwoWay}" WidthRequest="100" Keyboard="Numeric" />
                    <Label Text="Итого:" VerticalOptions="Center" />
                    <Label Text="{Binding Subtotal, Converter={StaticResource CurrencyConverter}}" FontAttributes="Bold" />
                  </StackLayout>
                  <Button Grid.Row="0"
                          Grid.Column="1"
                          Grid.RowSpan="3"
                          Text="Удалить"
                          Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.RemoveFromCartCommand}"
                          CommandParameter="{Binding .}"
                          Style="{StaticResource Button.Secondary}" />
                </Grid>
              </Border>
            </DataTemplate>
          </CollectionView.ItemTemplate>
          <CollectionView.EmptyView>
            <Label Text="Корзина пуста" HorizontalOptions="Center" VerticalOptions="Center" />
          </CollectionView.EmptyView>
        </CollectionView>

        <Border Grid.Row="2" Style="{StaticResource Card.Container}">
          <HorizontalStackLayout Spacing="12">
            <Label Text="Клиент:" VerticalOptions="Center" />
            <Entry Text="{Binding ClientName}" Placeholder="Введите имя клиента" />
          </HorizontalStackLayout>
        </Border>

        <Border Grid.Row="3" Style="{StaticResource Card.Container}" IsVisible="{Binding IsReservation}">
          <VerticalStackLayout Spacing="8">
            <HorizontalStackLayout Spacing="8">
              <Label Text="Оплата получена:" VerticalOptions="Center" />
              <Switch IsToggled="{Binding ReservationPaid}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Spacing="8">
              <Entry Placeholder="Комментарий"
                     Text="{Binding NewReservationNote}"
                     HorizontalOptions="FillAndExpand" />
              <Button Text="Добавить"
                      Command="{Binding AddReservationNoteCommand}"
                      Style="{StaticResource Button.Secondary}" />
            </HorizontalStackLayout>
            <CollectionView ItemsSource="{Binding ReservationNotes}" SelectionMode="None">
              <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="x:String">
                  <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label Text="{Binding .}" />
                    <Button Text="Удалить"
                            Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.RemoveReservationNoteCommand}"
                            CommandParameter="{Binding .}"
                            Style="{StaticResource Button.Tertiary}" />
                  </Grid>
                </DataTemplate>
              </CollectionView.ItemTemplate>
            </CollectionView>
          </VerticalStackLayout>
        </Border>

        <Grid Grid.Row="4" ColumnDefinitions="*,Auto" ColumnSpacing="12">
          <StackLayout Orientation="Horizontal" Spacing="12" VerticalOptions="Center">
            <Label Text="Итого:" FontAttributes="Bold" />
            <Label Text="{Binding Total, Converter={StaticResource CurrencyConverter}}" FontAttributes="Bold" />
          </StackLayout>
          <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="12">
            <Button Text="Клиент"
                    Clicked="OnPickClientClicked"
                    Style="{StaticResource Button.Secondary}" />
            <Button Text="Провести"
                    Command="{Binding SubmitCommand}"
                    IsEnabled="{Binding CanSubmit}"
                    Style="{StaticResource CtaPrimary}" />
          </StackLayout>
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</ContentPage>
