<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ProjectApp.Client.Maui.Views.DebtDetailPage"
             Title="Детали долга">
  <ContentPage.ToolbarItems>
    <ToolbarItem Text="Оплатить" Priority="0" Order="Primary" Command="{Binding PayCommand}" />
  </ContentPage.ToolbarItems>
  <ScrollView>
    <VerticalStackLayout Padding="24" Spacing="16">
      <!-- Header -->
      <VerticalStackLayout Spacing="6">
        <Label Text="Детали долга" FontSize="24" FontAttributes="Bold" />
        <Label Text="{Binding Debt.ClientName, FallbackValue=Клиент}" 
               FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}" />
      </VerticalStackLayout>

      <!-- Summary Card -->
      <Frame Style="{StaticResource CardFrame}">
        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="6">
          <Label Text="Сумма остатка:" />
          <Label Grid.Column="1" Text="{Binding Debt.Amount, StringFormat={}{0:N0} сум}" FontAttributes="Bold" />

          <Label Grid.Row="1" Text="Изначально:" />
          <Label Grid.Row="1" Grid.Column="1" Text="{Binding Debt.OriginalAmount, StringFormat={}{0:N0} сум}" />

          <Label Grid.Row="2" Text="Срок оплаты:" />
          <Label Grid.Row="2" Grid.Column="1" Text="{Binding Debt.DueDate, StringFormat={}{0:dd.MM.yyyy}}" />

          <Label Grid.Row="3" Text="Статус:" />
          <Label Grid.Row="3" Grid.Column="1" Text="{Binding Debt.Status}" />
        </Grid>
      </Frame>

      <!-- Items -->
      <VerticalStackLayout Spacing="8">
        <Label Text="Товары" FontAttributes="Bold" />
        <CollectionView ItemsSource="{Binding Items}">
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Frame Style="{StaticResource CardFrame}" Padding="16" Margin="0,8,0,0">
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                  <Label Text="{Binding ProductName}" FontAttributes="Bold" />
                  <Label Grid.Column="1" Text="{Binding Total, StringFormat={}{0:N0} сум}" />
                  <Label Grid.Row="1" Text="{Binding Sku}" TextColor="{DynamicResource Color.Text.Secondary}" />
                  <Label Grid.Row="1" Grid.Column="1" Text="{Binding Qty, StringFormat={}{0:N3}} x {Binding Price, StringFormat={}{0:N0}}" />
                </Grid>
              </Frame>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>
      </VerticalStackLayout>

      <!-- Payments -->
      <VerticalStackLayout Spacing="8">
        <HorizontalStackLayout Spacing="12">
          <Label Text="Оплаты" FontAttributes="Bold" />
          <Button Text="Оплатить" Style="{StaticResource Button.Primary}" Command="{Binding PayCommand}" />
        </HorizontalStackLayout>
        <CollectionView ItemsSource="{Binding Payments}">
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Frame Style="{StaticResource CardFrame}" Padding="16" Margin="0,8,0,0">
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                  <Label Text="{Binding PaidAt, StringFormat={}{0:dd.MM.yyyy HH:mm}}" />
                  <Label Grid.Column="1" Text="{Binding Amount, StringFormat={}{0:N0} сум}" FontAttributes="Bold" />
                  <Label Grid.Row="1" Text="{Binding Method}" TextColor="{DynamicResource Color.Text.Secondary}" />
                  <Label Grid.Row="1" Grid.Column="1" Text="{Binding Comment}" TextColor="{DynamicResource Color.Text.Secondary}" />
                </Grid>
              </Frame>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>
      </VerticalStackLayout>

      <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>
