<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.SalesHistoryPage"
             x:Name="Page"
             Title="История продаж">
  <CollectionView ItemsSource="{Binding Items}">
    <CollectionView.Header>
      <Frame Padding="16,16,16,8">
        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*,Auto,Auto" ColumnSpacing="8" RowSpacing="8">
          <HorizontalStackLayout Grid.Column="0" Spacing="8">
            <Label Text="От:" VerticalTextAlignment="Center"/>
            <DatePicker Date="{Binding DateFrom, Mode=TwoWay}"/>
          </HorizontalStackLayout>
          <HorizontalStackLayout Grid.Column="1" Spacing="8">
            <Label Text="До:" VerticalTextAlignment="Center"/>
            <DatePicker Date="{Binding DateTo, Mode=TwoWay}"/>
          </HorizontalStackLayout>
          <Button Grid.Column="2" Text="Обновить" Command="{Binding LoadCommand}" ImageSource="{StaticResource IconRefresh}" ContentLayout="Left,8"/>
          <HorizontalStackLayout Grid.Column="3" Spacing="8">
            <Label Text="Все продажи" VerticalTextAlignment="Center"/>
            <Switch IsToggled="{Binding ShowAll}"/>
          </HorizontalStackLayout>
          <ActivityIndicator Grid.Row="1" Grid.ColumnSpan="4" IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}"/>
        </Grid>
      </Frame>
    </CollectionView.Header>
    <CollectionView.ItemsLayout>
      <GridItemsLayout Orientation="Vertical" Span="2" />
    </CollectionView.ItemsLayout>
    <CollectionView.ItemTemplate>
      <DataTemplate>
        <Frame Style="{StaticResource CardFrame}">
          <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="8">
            <Label Grid.Row="0" Grid.ColumnSpan="2" Text="{Binding Id, StringFormat='Продажа #{0}'}" FontAttributes="Bold"/>
            <Label Grid.Row="1" Grid.Column="0" Text="{Binding CreatedAt, Converter={StaticResource DateTimeToRuConverter}}" FontSize="12" TextColor="Gray"/>
            <Button Grid.Row="1" Grid.Column="1" Text="Возврат" Command="{Binding Source={x:Reference Name=Page}, Path=BindingContext.OpenReturnCommand}" CommandParameter="{Binding .}" Style="{StaticResource OutlinedButton}" ImageSource="{StaticResource IconReturn}" ContentLayout="Left,8"/>
            <Label Grid.Row="2" Grid.Column="0" Text="{Binding ClientName}"/>
            <!-- Payment type badge -->
            <Frame Grid.Row="3" Grid.Column="0" Style="{StaticResource BadgeFrame}"
                   BackgroundColor="{Binding PaymentType, Converter={StaticResource PaymentTypeToColorConverter}, ConverterParameter=bg}"
                   BorderColor="{Binding PaymentType, Converter={StaticResource PaymentTypeToColorConverter}, ConverterParameter=border}">
              <Label Text="{Binding PaymentType, Converter={StaticResource PaymentTypeToRuConverter}}" FontSize="12"
                     TextColor="{Binding PaymentType, Converter={StaticResource PaymentTypeToColorConverter}, ConverterParameter=text}"/>
            </Frame>
            <Label Grid.Row="3" Grid.Column="1" Text="{Binding Total, Converter={StaticResource CurrencyConverter}, StringFormat='Сумма: {0}'}" HorizontalTextAlignment="End"/>
          </Grid>
        </Frame>
      </DataTemplate>
    </CollectionView.ItemTemplate>
    <CollectionView.EmptyView>
      <VerticalStackLayout Padding="12" Spacing="6">
        <Label Text="Нет продаж за выбранный период" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
        <Label Text="Измените даты или включите 'Все продажи'" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
      </VerticalStackLayout>
    </CollectionView.EmptyView>
  </CollectionView>
</ContentPage>
