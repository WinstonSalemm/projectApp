<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.CostingPage"
             x:Name="PageRoot"
             Title="💰 Расчёт себестоимости"
             x:DataType="vm:CostingViewModel">

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">
            
            <!-- Параметры расчета -->
            <Frame Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="📋 Параметры расчета" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Margin="0,0,0,10"/>

                    <!-- Курс -->
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Курс RUB→UZS:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ExchangeRate}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- Проценты -->
                    <Label Text="Проценты (к цене UZS):" FontAttributes="Bold" Margin="0,10,0,5"/>
                    
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="НДС (0.22 = 22%):" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding VatPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Логистика:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LogisticsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Склад:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding StoragePct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Декларация:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding DeclarationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Сертификация:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CertificationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="МЧС:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding MChsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Непредвиденные:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding UnforeseenPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- Абсолюты -->
                    <Label Text="Абсолюты (UZS, распред. по шт):" FontAttributes="Bold" Margin="0,10,0,5"/>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Таможня:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CustomsFeeAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Погрузка:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LoadingAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Возврат:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ReturnsAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Кнопки управления -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                <Button Grid.Column="0" 
                        Text="Создать"
                        Command="{Binding CreateSessionCommand}"
                        BackgroundColor="#3498db"
                        TextColor="White"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NullToBoolConverter}}"/>

                <Button Grid.Column="1" 
                        Text="🔄 Пересчитать"
                        Command="{Binding RecalculateCommand}"
                        BackgroundColor="#f39c12"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>

                <Button Grid.Column="2" 
                        Text="✅ Зафиксировать"
                        Command="{Binding FinalizeCommand}"
                        BackgroundColor="#27ae60"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>
            </Grid>

            <!-- Статус -->
            <Label Text="✅ ЗАФИКСИРОВАНО - только просмотр"
                   FontSize="14"
                   FontAttributes="Bold"
                   TextColor="#27ae60"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding IsFinalized}"/>

            <!-- Результаты расчета -->
            <Frame Padding="0" CornerRadius="10" HasShadow="True" IsVisible="{Binding Items.Count, Converter={StaticResource GreaterThanZeroConverter}}">
                <VerticalStackLayout>
                    <Label Text="📊 Результаты расчета" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Padding="15,15,15,10"/>

                    <CollectionView ItemsSource="{Binding Items}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="services:CostingItemDto">
                                <Frame Margin="10,5" 
                                       Padding="10" 
                                       CornerRadius="8" 
                                       BackgroundColor="#f8f9fa"
                                       BorderColor="#dee2e6">
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Name}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Количество:" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding Quantity, StringFormat='{0} шт'}" FontAttributes="Bold"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Цена (RUB):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceRub, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Цена (UZS):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceUzs, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Label Text="Расшифровка:" FontSize="12" FontAttributes="Bold" TextColor="Gray"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="НДС:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding VatUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="Таможня:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding CustomsUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="Погрузка:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding LoadingUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="💵 ИТОГО (UZS):" FontAttributes="Bold" TextColor="#2c3e50"/>
                                            <Label Grid.Column="1" Text="{Binding TotalCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#2c3e50"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="💵 За 1 шт:" FontAttributes="Bold" TextColor="#e74c3c"/>
                                            <Label Grid.Column="1" Text="{Binding UnitCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#e74c3c"/>
                                        </Grid>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Детализация расчета -->
                    <Label Text="Детализация расчёта" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           Padding="15,10,15,0"/>

                    <ScrollView Orientation="Both" HeightRequest="260" Margin="15,5,15,10">
                        <VerticalStackLayout>
                            <Grid ColumnDefinitions="2*,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" Padding="5" BackgroundColor="#ecf0f1">
                                <Label Text="Товар" FontAttributes="Bold" />
                                <Label Grid.Column="1" Text="Кол-во" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="2" Text="Цена ₽" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="3" Text="Курс" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="4" Text="Цена UZS" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="5" Text="Таможня" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="6" Text="НДС" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="7" Text="Логистика" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="8" Text="Склад" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="9" Text="Декларация" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="10" Text="Сертификация" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="11" Text="МЧС" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="12" Text="Погрузка" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="13" Text="Отклонения" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                <Label Grid.Column="14" Text="Себестоимость / итого" FontAttributes="Bold" HorizontalTextAlignment="End" />
                            </Grid>

                            <CollectionView ItemsSource="{Binding DetailingItems}" SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="services:CostingItemDto">
                                        <Border Stroke="#f0f0f0" StrokeThickness="1" Background="White" Padding="0">
                                            <Grid ColumnDefinitions="2*,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" Padding="5">
                                                <Label Text="{Binding Name}" />
                                                <Label Grid.Column="1" Text="{Binding Quantity, StringFormat='{0} шт'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="2" Text="{Binding PriceRub, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="3" Text="{Binding Source={x:Reference PageRoot}, Path=BindingContext.ExchangeRate, StringFormat='{0:N4}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="4" Text="{Binding PriceUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="5" Text="{Binding CustomsUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="6" Text="{Binding VatUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="7" Text="{Binding LogisticsUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="8" Text="{Binding StorageUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="9" Text="{Binding DeclarationUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="10" Text="{Binding CertificationUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="11" Text="{Binding MChsUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="12" Text="{Binding LoadingUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="13" Text="{Binding UnforeseenUzs, StringFormat='{0:N2}'}" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="14" Text="{Binding TotalCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#2c3e50" HorizontalTextAlignment="End" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Формулы -->
                    <VerticalStackLayout Padding="15,0,15,10" Spacing="2">
                        <Label Text="Формулы расчёта" FontAttributes="Bold" FontSize="14" />
                        <Label Text="• Цена UZS = Цена ₽ × Курс" FontSize="12" TextColor="Gray" />
                        <Label Text="• Процентные статьи (НДС, логистика, склад, сертификация, МЧС) считаются от цены в UZS; фиксированные статьи (таможня, погрузка) распределяются пропорционально доле товара" FontSize="12" TextColor="Gray" />
                    </VerticalStackLayout>

                    <!-- Общая сумма -->
                    <Frame Padding="15" 
                           BackgroundColor="#27ae60" 
                           CornerRadius="0"
                           Margin="0">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" 
                                   Text="🎯 ОБЩАЯ СЕБЕСТОИМОСТЬ:" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Grid.Column="1" 
                                   Text="{Binding GrandTotal, StringFormat='{0:N2} UZS'}" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                              IsVisible="{Binding IsBusy}"
                              Color="Blue"
                              HeightRequest="50"/>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
