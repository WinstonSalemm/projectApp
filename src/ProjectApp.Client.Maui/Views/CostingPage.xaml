<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             xmlns:converters="clr-namespace:ProjectApp.Client.Maui.Converters"
             x:Class="ProjectApp.Client.Maui.Views.CostingPage"
             x:Name="PageRoot"
             Title="💰 Расчёт себестоимости"
             x:DataType="vm:CostingViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:CurrencyConverter x:Key="CurrencyConverter" />
            <converters:PercentConverter x:Key="PercentConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">
             <Label Text="я в рот ебал всё это"
           FontSize="100"
           TextColor="Red"
           HorizontalTextAlignment="Center"
           Margin="0,20,0,20"/>
            <!-- Параметры расчета -->
            <Frame Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="📋 Параметры расчета" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Margin="0,0,0,10"/>

                    <!-- Курс -->
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Курс RUB→UZS:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ExchangeRate}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- Проценты -->
                    <Label Text="Проценты (к цене UZS):" FontAttributes="Bold" Margin="0,10,0,5"/>
                    
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="НДС (0.22 = 22%):" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding VatPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Логистика:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LogisticsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Склад:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding StoragePct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Декларация:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding DeclarationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Сертификация:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CertificationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="МЧС:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding MChsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Непредвиденные:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding UnforeseenPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- Абсолюты -->
                    <Label Text="Абсолюты (UZS, распред. по шт):" FontAttributes="Bold" Margin="0,10,0,5"/>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Таможня:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CustomsFeeAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="в рот ебал:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LoadingAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Возврат:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ReturnsAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Кнопки управления -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                <Button Grid.Column="0" 
                        Text="Создать"
                        Command="{Binding CreateSessionCommand}"
                        BackgroundColor="#3498db"
                        TextColor="White"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NullToBoolConverter}}"/>

                <Button Grid.Column="1" 
                        Text="🔄 Пересчитать"
                        Command="{Binding RecalculateCommand}"
                        BackgroundColor="#f39c12"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>

                <Button Grid.Column="2" 
                        Text="✅ Зафиксировать"
                        Command="{Binding FinalizeCommand}"
                        BackgroundColor="#27ae60"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>
            </Grid>

            <!-- Статус -->
            <Label Text="✅ ЗАФИКСИРОВАНО - только просмотр"
                   FontSize="14"
                   FontAttributes="Bold"
                   TextColor="#27ae60"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding IsFinalized}"/>

            <!-- Результаты расчета -->
            <Frame Padding="0" CornerRadius="10" HasShadow="True" IsVisible="{Binding Items.Count, Converter={StaticResource GreaterThanZeroConverter}}">
                <VerticalStackLayout>
                    <Label Text="📊 Результаты расчета" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Padding="15,15,15,10"/>

                    <CollectionView ItemsSource="{Binding Items}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="services:CostingItemDto">
                                <Frame Margin="10,5" 
                                       Padding="10" 
                                       CornerRadius="8" 
                                       BackgroundColor="#f8f9fa"
                                       BorderColor="#dee2e6">
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Name}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Количество:" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding Quantity, StringFormat='{0} шт'}" FontAttributes="Bold"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Цена (RUB):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceRub, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Цена (UZS):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceUzs, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Label Text="Расшифровка:" FontSize="12" FontAttributes="Bold" TextColor="Gray"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="НДС:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding VatUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="Таможня:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding CustomsUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="Погрузка:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding LoadingUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="💵 ИТОГО (UZS):" FontAttributes="Bold" TextColor="#2c3e50"/>
                                            <Label Grid.Column="1" Text="{Binding TotalCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#2c3e50"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="💵 За 1 шт:" FontAttributes="Bold" TextColor="#e74c3c"/>
                                            <Label Grid.Column="1" Text="{Binding UnitCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#e74c3c"/>
                                        </Grid>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Детализация расчета -->
                    <Label Text="Детализация расчёта" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           Padding="15,10,15,0"/>

                    <ScrollView Orientation="Both" HeightRequest="260" Margin="15,5,15,10">
                        <VerticalStackLayout>
                            <Grid ColumnDefinitions="260,110,90,140,140,140,140,140,140,140,140,140,140,160"
                                  Padding="6" BackgroundColor="#ecf0f1" ColumnSpacing="12">
                                <Label Text="Товар" FontAttributes="Bold" />
                                <Label Grid.Column="1" Text="Цена ₽" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="2" Text="В РОТ ЕБАЛ ВСЁ" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="3" Text="Цена UZS" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="4" Text="Таможня" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="5" Text="НДС" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="6" Text="Логистика" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="7" Text="Склад" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="8" Text="Декларация" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="9" Text="Сертификация" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="10" Text="МЧС" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="11" Text="Погрузка" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="12" Text="Отклонения" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Grid.Column="13" Text="Себес / итого" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                            </Grid>

                            <CollectionView ItemsSource="{Binding DetailingItems}" SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="services:CostingItemDto">
                                        <Grid ColumnSpacing="12"
                                              Padding="8"
                                              ColumnDefinitions="260,110,90,140,140,140,140,140,140,140,140,140,140,160">
                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                <Label Text="{Binding Name}"
                                                       FontAttributes="Bold"
                                                       FontSize="13"
                                                       LineBreakMode="TailTruncation"/>
                                                <Label FontSize="11" TextColor="Gray"
                                                       Text="{Binding Quantity, StringFormat='Кол-во: {0}'}"/>
                                            </VerticalStackLayout>

                                            <Label Grid.Column="1"
                                                   Text="{Binding PriceRub, StringFormat='{}{0:N2}'}"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"/>

                                            <Label Grid.Column="2"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ExchangeRate, StringFormat='{}{0:N2}'}"/>

                                            <Label Grid.Column="3"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding PriceUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="4"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding CustomsUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="5"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding VatUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="6"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding LogisticsUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="7"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding StorageUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="8"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding DeclarationUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="9"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding CertificationUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="10"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding MChsUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="11"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding LoadingUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="12"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   Text="{Binding UnforeseenUzs, Converter={StaticResource CurrencyConverter}}"/>

                                            <Label Grid.Column="13"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   Text="{Binding TotalCostUzs, Converter={StaticResource CurrencyConverter}}"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Формулы -->
                    <Label Margin="15,0,15,10" Opacity="0.8">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Формулы: " FontAttributes="Bold" />
                                <Span Text="Цена UZS = Цена ₽ × Курс. Процентные статьи считаются от цены в UZS. Фиксированные суммы (таможня/погрузка) распределяются пропорционально доле товара." />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <!-- Общая сумма -->
                    <Frame Padding="15" 
                           BackgroundColor="#27ae60" 
                           CornerRadius="0"
                           Margin="0">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" 
                                   Text="🎯 ОБЩАЯ СЕБЕСТОИМОСТЬ:" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Grid.Column="1" 
                                   Text="{Binding GrandTotal, StringFormat='{0:N2} UZS'}" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                              IsVisible="{Binding IsBusy}"
                              Color="Blue"
                              HeightRequest="50"/>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
