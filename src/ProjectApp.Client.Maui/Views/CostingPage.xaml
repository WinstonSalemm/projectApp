<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.CostingPage"
             Title="ðŸ’° Ð Ð°ÑÑ‡Ñ‘Ñ‚ ÑÐµÐ±ÐµÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸"
             x:DataType="vm:CostingViewModel">

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">
            
            <!-- ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° -->
            <Frame Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“‹ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Margin="0,0,0,10"/>

                    <!-- ÐšÑƒÑ€Ñ -->
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="ÐšÑƒÑ€Ñ RUBâ†’UZS:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ExchangeRate}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ -->
                    <Label Text="ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ (Ðº Ñ†ÐµÐ½Ðµ UZS):" FontAttributes="Bold" Margin="0,10,0,5"/>
                    
                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="ÐÐ”Ð¡ (0.22 = 22%):" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding VatPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ°:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LogisticsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð¡ÐºÐ»Ð°Ð´:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding StoragePct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð”ÐµÐºÐ»Ð°Ñ€Ð°Ñ†Ð¸Ñ:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding DeclarationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CertificationPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="ÐœÐ§Ð¡:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding MChsPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="ÐÐµÐ¿Ñ€ÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ñ‹Ðµ:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding UnforeseenPct}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <!-- ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ñ‹ -->
                    <Label Text="ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ñ‹ (UZS, Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´. Ð¿Ð¾ ÑˆÑ‚):" FontAttributes="Bold" Margin="0,10,0,5"/>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð¢Ð°Ð¼Ð¾Ð¶Ð½Ñ:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding CustomsFeeAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="ÐŸÐ¾Ð³Ñ€ÑƒÐ·ÐºÐ°:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding LoadingAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*,2*">
                        <Label Grid.Column="0" Text="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚:" VerticalOptions="Center"/>
                        <Entry Grid.Column="1" 
                               Text="{Binding ReturnsAbs}" 
                               Keyboard="Numeric"
                               IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                <Button Grid.Column="0" 
                        Text="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"
                        Command="{Binding CreateSessionCommand}"
                        BackgroundColor="#3498db"
                        TextColor="White"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NullToBoolConverter}}"/>

                <Button Grid.Column="1" 
                        Text="ðŸ”„ ÐŸÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ"
                        Command="{Binding RecalculateCommand}"
                        BackgroundColor="#f39c12"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>

                <Button Grid.Column="2" 
                        Text="âœ… Ð—Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"
                        Command="{Binding FinalizeCommand}"
                        BackgroundColor="#27ae60"
                        TextColor="White"
                        IsEnabled="{Binding IsFinalized, Converter={StaticResource InvertedBoolConverter}}"
                        IsVisible="{Binding CurrentSessionId, Converter={StaticResource NotNullToBoolConverter}}"/>
            </Grid>

            <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ -->
            <Label Text="âœ… Ð—ÐÐ¤Ð˜ÐšÐ¡Ð˜Ð ÐžÐ’ÐÐÐž - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€"
                   FontSize="14"
                   FontAttributes="Bold"
                   TextColor="#27ae60"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding IsFinalized}"/>

            <!-- Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° -->
            <Frame Padding="0" CornerRadius="10" HasShadow="True" IsVisible="{Binding Items.Count, Converter={StaticResource GreaterThanZeroConverter}}">
                <VerticalStackLayout>
                    <Label Text="ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           Padding="15,15,15,10"/>

                    <CollectionView ItemsSource="{Binding Items}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="services:CostingItemDto">
                                <Frame Margin="10,5" 
                                       Padding="10" 
                                       CornerRadius="8" 
                                       BackgroundColor="#f8f9fa"
                                       BorderColor="#dee2e6">
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Name}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾:" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding Quantity, StringFormat='{0} ÑˆÑ‚'}" FontAttributes="Bold"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Ð¦ÐµÐ½Ð° (RUB):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceRub, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="Ð¦ÐµÐ½Ð° (UZS):" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding PriceUzs, StringFormat='{0:N2}'}" />
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Label Text="Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°:" FontSize="12" FontAttributes="Bold" TextColor="Gray"/>
                                        
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="ÐÐ”Ð¡:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding VatUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="Ð¢Ð°Ð¼Ð¾Ð¶Ð½Ñ:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding CustomsUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="5">
                                            <Label Grid.Column="0" Text="ÐŸÐ¾Ð³Ñ€ÑƒÐ·ÐºÐ°:" FontSize="11" TextColor="Gray"/>
                                            <Label Grid.Column="1" Text="{Binding LoadingUzs, StringFormat='{0:N2}'}" FontSize="11"/>
                                        </Grid>

                                        <BoxView HeightRequest="1" Color="LightGray" Margin="0,5"/>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="ðŸ’µ Ð˜Ð¢ÐžÐ“Ðž (UZS):" FontAttributes="Bold" TextColor="#2c3e50"/>
                                            <Label Grid.Column="1" Text="{Binding TotalCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#2c3e50"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" Text="ðŸ’µ Ð—Ð° 1 ÑˆÑ‚:" FontAttributes="Bold" TextColor="#e74c3c"/>
                                            <Label Grid.Column="1" Text="{Binding UnitCostUzs, StringFormat='{0:N2}'}" FontAttributes="Bold" TextColor="#e74c3c"/>
                                        </Grid>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- ÐžÐ±Ñ‰Ð°Ñ ÑÑƒÐ¼Ð¼Ð° -->
                    <Frame Padding="15" 
                           BackgroundColor="#27ae60" 
                           CornerRadius="0"
                           Margin="0">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" 
                                   Text="ðŸŽ¯ ÐžÐ‘Ð©ÐÐ¯ Ð¡Ð•Ð‘Ð•Ð¡Ð¢ÐžÐ˜ÐœÐžÐ¡Ð¢Ð¬:" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Grid.Column="1" 
                                   Text="{Binding GrandTotal, StringFormat='{0:N2} UZS'}" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                              IsVisible="{Binding IsBusy}"
                              Color="Blue"
                              HeightRequest="50"/>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
