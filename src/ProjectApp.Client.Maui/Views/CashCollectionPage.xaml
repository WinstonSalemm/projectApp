<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.CashCollectionPage"
             x:DataType="vm:CashCollectionViewModel"
             Title="ðŸ’µ Ðš Ð¸Ð½ÐºÐ°ÑÑÐ°Ñ†Ð¸Ð¸"
             BackgroundColor="{DynamicResource Color.Background}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Command="{Binding LoadDataCommand}" />
        <ToolbarItem Text="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ" Command="{Binding DeleteLastCommand}" />
    </ContentPage.ToolbarItems>

    <ScrollView VerticalScrollBarVisibility="Always">
        <VerticalStackLayout Padding="16" Spacing="20">

            <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                             IsVisible="{Binding IsLoading}"
                             HeightRequest="50" />

            <!-- ÐžÑˆÐ¸Ð±ÐºÐ° -->
            <Frame IsVisible="{Binding HasError}"
                   BackgroundColor="{DynamicResource Color.Error}"
                   Padding="12"
                   HasShadow="False">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="{DynamicResource Color.OnPrimary}"
                       FontSize="14" />
            </Frame>

            <!-- ÐÐÐšÐžÐŸÐ›Ð•ÐÐž Ð¡ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ•Ð™ Ð˜ÐÐšÐÐ¡Ð¡ÐÐ¦Ð˜Ð˜ -->
            <Frame Style="{StaticResource Card}" Padding="20">
                <VerticalStackLayout Spacing="8">
                    <Label Text="ðŸ“ˆ ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¾ Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¸Ð½ÐºÐ°ÑÑÐ°Ñ†Ð¸Ð¸:"
                           FontSize="14"
                           TextColor="{DynamicResource Color.Text.Secondary}"
                           FontFamily="InterSemiBold" />
                    
                    <Label Text="{Binding CurrentAccumulatedFormatted}"
                           FontSize="32"
                           TextColor="{DynamicResource Color.Primary}"
                           FontFamily="InterBold"
                           HorizontalOptions="Center" />
                    
                    <Label Text="{Binding LastCollectionDateFormatted, StringFormat='Ð¡ {0}'}"
                           FontSize="12"
                           TextColor="{DynamicResource Color.Text.Tertiary}"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Frame>

            <!-- ÐÐ•Ð˜ÐÐšÐÐ¡Ð¡Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð™ ÐžÐ¡Ð¢ÐÐ¢ÐžÐš -->
            <Frame Style="{StaticResource Card}" Padding="20">
                <VerticalStackLayout Spacing="8">
                    <Label Text="ðŸ’¼ ÐÐµÐ¸Ð½ÐºÐ°ÑÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº:"
                           FontSize="14"
                           TextColor="{DynamicResource Color.Text.Secondary}"
                           FontFamily="InterSemiBold" />
                    
                    <Label Text="{Binding TotalRemainingFormatted}"
                           FontSize="28"
                           TextColor="{DynamicResource Color.Primary}"
                           FontFamily="InterBold"
                           HorizontalOptions="Center" />
                    
                    <Label Text="(Cash Flow Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¸)"
                           FontSize="11"
                           TextColor="{DynamicResource Color.Text.Tertiary}"
                           HorizontalOptions="Center"
                           FontAttributes="Italic" />
                </VerticalStackLayout>
            </Frame>

            <!-- Ð¤ÐžÐ ÐœÐ Ð˜ÐÐšÐÐ¡Ð¡ÐÐ¦Ð˜Ð˜ -->
            <Frame Style="{StaticResource Card}" Padding="20">
                <VerticalStackLayout Spacing="16">
                    <Label Text="ðŸ“¤ ÐŸÑ€Ð¾Ð²ÐµÑÑ‚Ð¸ Ð¸Ð½ÐºÐ°ÑÑÐ°Ñ†Ð¸ÑŽ"
                           FontSize="16"
                           TextColor="{DynamicResource Color.Text.Primary}"
                           FontFamily="InterBold" />

                    <!-- Ð¡ÑƒÐ¼Ð¼Ð° Ðº ÑÐ´Ð°Ñ‡Ðµ -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Ð¡ÑƒÐ¼Ð¼Ð° Ðº ÑÐ´Ð°Ñ‡Ðµ (UZS):"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Entry Text="{Binding CollectedAmountText}"
                               Placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 180000000"
                               Keyboard="Numeric"
                               FontSize="16" />
                    </VerticalStackLayout>

                    <!-- ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾):"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Editor Text="{Binding Notes}"
                                Placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 20Ðœ Ð½Ð° Ð´Ð¸Ð²Ð¸Ð´ÐµÐ½Ð´Ñ‹, 10Ðœ Ñ€ÐµÐ·ÐµÑ€Ð²"
                                HeightRequest="80"
                                FontSize="14" />
                    </VerticalStackLayout>

                    <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° -->
                    <Button Text="ðŸ“¤ ÐŸÑ€Ð¾Ð²ÐµÑÑ‚Ð¸ Ð¸Ð½ÐºÐ°ÑÑÐ°Ñ†Ð¸ÑŽ"
                            Command="{Binding SubmitCollectionCommand}"
                            IsEnabled="{Binding CanSubmit}"
                            Style="{StaticResource CtaPrimary}" />
                </VerticalStackLayout>
            </Frame>

            <!-- Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð˜ÐÐšÐÐ¡Ð¡ÐÐ¦Ð˜Ð™ -->
            <Label Text="ðŸ“œ Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð˜ÐÐšÐÐ¡Ð¡ÐÐ¦Ð˜Ð™"
                   FontSize="16"
                   TextColor="{DynamicResource Color.Text.Primary}"
                   FontFamily="InterBold"
                   Margin="0,12,0,0" />

            <CollectionView ItemsSource="{Binding History}"
                          EmptyView="ÐÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸Ð½ÐºÐ°ÑÑÐ°Ñ†Ð¸Ð¹">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:CashCollectionHistoryRow">
                        <Frame Margin="0,0,0,12"
                               Padding="16"
                               Style="{StaticResource CardFrame}">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                                  ColumnDefinitions="120,*"
                                  RowSpacing="8">
                                
                                <!-- Ð”Ð°Ñ‚Ð° -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="ðŸ“… Ð”Ð°Ñ‚Ð°:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Date}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Primary}"
                                       FontFamily="InterSemiBold" />

                                <!-- ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¾ -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="ðŸ“Š ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¾:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Accumulated}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Primary}"
                                       FontFamily="InterSemiBold" />

                                <!-- Ð¡Ð´Ð°Ð½Ð¾ -->
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="ðŸ’µ Ð¡Ð´Ð°Ð½Ð¾:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="2" Grid.Column="1"
                                       Text="{Binding Collected}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Primary}"
                                       FontFamily="InterSemiBold" />

                                <!-- ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº -->
                                <Label Grid.Row="3" Grid.Column="0"
                                       Text="ðŸ’¼ ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="3" Grid.Column="1"
                                       Text="{Binding Remaining}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Primary}"
                                       FontFamily="InterSemiBold" />

                                <!-- ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ -->
                                <Label Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding Notes}"
                                       FontSize="11"
                                       TextColor="{DynamicResource Color.Text.Tertiary}"
                                       FontAttributes="Italic"
                                       IsVisible="{Binding Notes, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                       LineBreakMode="WordWrap" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ÐŸÑƒÑÑ‚Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð²Ð½Ð¸Ð·Ñƒ -->
            <BoxView HeightRequest="20" Color="Transparent" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
