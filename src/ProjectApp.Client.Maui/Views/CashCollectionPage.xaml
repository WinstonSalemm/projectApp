<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.CashCollectionPage"
             x:DataType="vm:CashCollectionViewModel"
             Title="💵 К инкассации">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Обновить" Command="{Binding LoadDataCommand}" />
        <ToolbarItem Text="Удалить последнюю" Command="{Binding DeleteLastCommand}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="20">

            <!-- Индикатор загрузки -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                             IsVisible="{Binding IsLoading}"
                             HeightRequest="50" />

            <!-- Ошибка -->
            <Frame IsVisible="{Binding HasError}"
                   BackgroundColor="#FFE5E5"
                   BorderColor="#FF0000"
                   CornerRadius="8"
                   Padding="12">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#CC0000"
                       FontSize="14" />
            </Frame>

            <!-- НАКОПЛЕНО С ПОСЛЕДНЕЙ ИНКАССАЦИИ -->
            <Frame BackgroundColor="#E3F2FD" 
                   BorderColor="#2196F3"
                   CornerRadius="12"
                   Padding="20">
                <VerticalStackLayout Spacing="8">
                    <Label Text="📈 Накоплено с последней инкассации:"
                           FontSize="14"
                           TextColor="#1976D2"
                           FontFamily="InterSemiBold" />
                    
                    <Label Text="{Binding CurrentAccumulatedFormatted}"
                           FontSize="32"
                           TextColor="#0D47A1"
                           FontFamily="InterBold"
                           HorizontalOptions="Center" />
                    
                    <Label Text="{Binding LastCollectionDateFormatted, StringFormat='С {0}'}"
                           FontSize="12"
                           TextColor="#64B5F6"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Frame>

            <!-- НЕИНКАССИРОВАННЫЙ ОСТАТОК -->
            <Frame BackgroundColor="#FFF3E0" 
                   BorderColor="#FF9800"
                   CornerRadius="12"
                   Padding="20">
                <VerticalStackLayout Spacing="8">
                    <Label Text="💼 Неинкассированный остаток:"
                           FontSize="14"
                           TextColor="#F57C00"
                           FontFamily="InterSemiBold" />
                    
                    <Label Text="{Binding TotalRemainingFormatted}"
                           FontSize="28"
                           TextColor="#E65100"
                           FontFamily="InterBold"
                           HorizontalOptions="Center" />
                    
                    <Label Text="(Cash Flow на предприятии)"
                           FontSize="11"
                           TextColor="#FFB74D"
                           HorizontalOptions="Center"
                           FontStyle="Italic" />
                </VerticalStackLayout>
            </Frame>

            <!-- ФОРМА ИНКАССАЦИИ -->
            <Frame BackgroundColor="White" 
                   BorderColor="#BDBDBD"
                   CornerRadius="12"
                   Padding="20">
                <VerticalStackLayout Spacing="16">
                    <Label Text="📤 Провести инкассацию"
                           FontSize="16"
                           TextColor="#424242"
                           FontFamily="InterBold" />

                    <!-- Сумма к сдаче -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Сумма к сдаче (UZS):"
                               FontSize="13"
                               TextColor="#757575" />
                        <Entry Text="{Binding CollectedAmountText}"
                               Placeholder="Например: 180000000"
                               Keyboard="Numeric"
                               FontSize="16"
                               BackgroundColor="#F5F5F5"
                               TextColor="#212121" />
                    </VerticalStackLayout>

                    <!-- Примечание -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Примечание (опционально):"
                               FontSize="13"
                               TextColor="#757575" />
                        <Editor Text="{Binding Notes}"
                                Placeholder="Например: 20М на дивиденды, 10М резерв"
                                HeightRequest="80"
                                FontSize="14"
                                BackgroundColor="#F5F5F5"
                                TextColor="#212121" />
                    </VerticalStackLayout>

                    <!-- Кнопка -->
                    <Button Text="📤 Провести инкассацию"
                            Command="{Binding SubmitCollectionCommand}"
                            IsEnabled="{Binding CanSubmit}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            FontFamily="InterBold"
                            FontSize="16"
                            Padding="0,12"
                            CornerRadius="8" />
                </VerticalStackLayout>
            </Frame>

            <!-- ИСТОРИЯ ИНКАССАЦИЙ -->
            <Label Text="📜 ИСТОРИЯ ИНКАССАЦИЙ"
                   FontSize="16"
                   TextColor="#424242"
                   FontFamily="InterBold"
                   Margin="0,12,0,0" />

            <CollectionView ItemsSource="{Binding History}"
                          EmptyView="Нет истории инкассаций">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:CashCollectionHistoryRow">
                        <Frame Margin="0,0,0,12"
                               Padding="16"
                               BackgroundColor="White"
                               BorderColor="#E0E0E0"
                               CornerRadius="8">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                                  ColumnDefinitions="120,*"
                                  RowSpacing="8">
                                
                                <!-- Дата -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="📅 Дата:"
                                       FontSize="12"
                                       TextColor="#757575" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Date}"
                                       FontSize="12"
                                       TextColor="#212121"
                                       FontFamily="InterSemiBold" />

                                <!-- Накоплено -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="📊 Накоплено:"
                                       FontSize="12"
                                       TextColor="#757575" />
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Accumulated}"
                                       FontSize="12"
                                       TextColor="#2196F3"
                                       FontFamily="InterSemiBold" />

                                <!-- Сдано -->
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="💵 Сдано:"
                                       FontSize="12"
                                       TextColor="#757575" />
                                <Label Grid.Row="2" Grid.Column="1"
                                       Text="{Binding Collected}"
                                       FontSize="12"
                                       TextColor="#4CAF50"
                                       FontFamily="InterSemiBold" />

                                <!-- Остаток -->
                                <Label Grid.Row="3" Grid.Column="0"
                                       Text="💼 Остаток:"
                                       FontSize="12"
                                       TextColor="#757575" />
                                <Label Grid.Row="3" Grid.Column="1"
                                       Text="{Binding Remaining}"
                                       FontSize="12"
                                       TextColor="#FF9800"
                                       FontFamily="InterSemiBold" />

                                <!-- Примечание -->
                                <Label Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding Notes}"
                                       FontSize="11"
                                       TextColor="#9E9E9E"
                                       FontStyle="Italic"
                                       IsVisible="{Binding Notes, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                       LineBreakMode="WordWrap" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Пустое место внизу -->
            <BoxView HeightRequest="20" Color="Transparent" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
