<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.ContractCreatePage"
             x:DataType="viewModels:ContractCreateViewModel"
             x:Name="Root"
             Title="Создать договор">
  <ScrollView>
    <VerticalStackLayout Padding="12" Spacing="12">
      <!-- Тип договора -->
      <HorizontalStackLayout Spacing="12">
        <Label Text="Тип:" VerticalTextAlignment="Center" FontAttributes="Bold"/>
        <Picker ItemsSource="{Binding ContractTypes}" SelectedItem="{Binding Type}" WidthRequest="180"/>
      </HorizontalStackLayout>
      
      <!-- Основные данные -->
      <Entry Placeholder="Номер договора (опционально)" Text="{Binding ContractNumber}"/>
      <Entry Placeholder="ID клиента (опционально)" Keyboard="Numeric" Text="{Binding ClientId, Converter={StaticResource NullableIntConverter}}"/>
      <Entry Placeholder="Организация *" Text="{Binding OrgName}"/>
      <Entry Placeholder="ИНН" Text="{Binding Inn}"/>
      <Entry Placeholder="Телефон" Text="{Binding Phone}"/>
      <Editor Placeholder="Описание" Text="{Binding Description}" HeightRequest="60"/>
      
      <!-- Сумма для открытого договора -->
      <Entry Placeholder="Сумма (для открытого договора)" Keyboard="Numeric" Text="{Binding TotalAmount}" IsVisible="{Binding Type, Converter={StaticResource StringEqualConverter}, ConverterParameter=Open}"/>
      
      <Editor Placeholder="Заметка" Text="{Binding Note}" HeightRequest="60"/>

      <Label Text="Позиции" FontAttributes="Bold"/>
      <Grid ColumnDefinitions="Auto,*,80,100,Auto" ColumnSpacing="8" RowDefinitions="Auto,Auto">
        <Button Grid.Column="0" Text="Выбрать товар" Clicked="OnPickProductClicked"/>
        <Entry Grid.Column="1" Placeholder="Название" Text="{Binding NewName}"/>
        <Entry Grid.Column="2" Placeholder="Ед." Text="{Binding NewUnit}"/>
        <Entry Grid.Column="3" Placeholder="Кол-во" Keyboard="Numeric" Text="{Binding NewQty}"/>
        <Entry Grid.Column="4" Placeholder="Цена" Keyboard="Numeric" Text="{Binding NewUnitPrice}"/>
      </Grid>
      <HorizontalStackLayout Spacing="12">
        <Label Text="{Binding SelectedNd40Qty, StringFormat='ND-40: {0}'}" FontSize="11"/>
        <Label Text="{Binding SelectedIm40Qty, StringFormat='IM-40: {0}'}" FontSize="11"/>
        <Label Text="{Binding SelectedTotalQty, StringFormat='Всего: {0}'}" FontSize="11"/>
      </HorizontalStackLayout>
      <Button Text="Добавить позицию" Command="{Binding AddItemCommand}"/>
      <Label TextColor="Red" Text="{Binding EditorMessage}"/>

      <CollectionView ItemsSource="{Binding Items}">
        <CollectionView.ItemTemplate>
          <DataTemplate x:DataType="services:ContractItemDraft">
            <Grid ColumnDefinitions="*,80,100,100,Auto" Padding="4" ColumnSpacing="8">
                            <Label Grid.Column="0" Text="{Binding Name}"/>
                            <Label Grid.Column="1" Text="{Binding Unit}"/>
              <Label Grid.Column="2" Text="{Binding Qty}"/>
              <Label Grid.Column="3" Text="{Binding UnitPrice}"/>
              <Button Grid.Column="4" Text="Удалить" Command="{Binding Source={x:Reference Name=Root}, Path=BindingContext.RemoveItemCommand}" CommandParameter="{Binding .}"/>
            </Grid>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>

      <Button Text="Создать договор" Command="{Binding CreateCommand}"/>
      <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}"/>
      <Label TextColor="Red" Text="{Binding StatusMessage}"/>
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>


