<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.ContractsPage"
             x:DataType="vm:ContractsViewModel"
             Title="Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°"
             BackgroundColor="{DynamicResource Color.Background}">
    
    <ContentPage.Resources>
        <ResourceDictionary />
    </ContentPage.Resources>
    
    <Grid RowDefinitions="Auto,Auto,*" 
          Padding="16,12,16,16"
          RowSpacing="20">
        
        <!-- Ð¢Ð¸Ð¿ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð° - Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ñ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒÑŽ -->
        <FlexLayout Grid.Row="0" 
                    Direction="Row"
                    Wrap="Wrap"
                    JustifyContent="Center"
                    AlignItems="Center">
            
            <Button Text="ðŸ“‚ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°" 
                    Style="{StaticResource TypeButton}"
                    Command="{Binding SelectTypeCommand}"
                    CommandParameter="Open"
                    Margin="6"
                    BackgroundColor="{Binding SelectedType, Converter={StaticResource StringEqualToColorConverter}, ConverterParameter=Open}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" 
                                 Binding="{Binding SelectedType}" 
                                 Value="Open">
                        <Setter Property="Scale" Value="1.02"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            
            <Button Text="ðŸ“‹ Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°" 
                    Style="{StaticResource TypeButton}"
                    Command="{Binding SelectTypeCommand}"
                    CommandParameter="Closed"
                    Margin="6"
                    BackgroundColor="{Binding SelectedType, Converter={StaticResource StringEqualToColorConverter}, ConverterParameter=Closed}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" 
                                 Binding="{Binding SelectedType}" 
                                 Value="Closed">
                        <Setter Property="Scale" Value="1.02"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
        </FlexLayout>

        <!-- Toolbar - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ -->
        <FlexLayout Grid.Row="1" 
                    Direction="Row"
                    Wrap="Wrap"
                    JustifyContent="Start"
                    AlignItems="Center">
            
            <Button Text="âž• Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€" 
                    Style="{StaticResource ActionButton}"
                    Command="{Binding CreateContractCommand}"
                    Margin="0,0,12,0"/>
            
            <Button Text="ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" 
                    Style="{StaticResource ActionButton}"
                    Command="{Binding LoadContractsCommand}"/>
        </FlexLayout>

        <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð¸ Ð¿ÑƒÑÑ‚Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ -->
        <Grid Grid.Row="2">
            
            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð² Ñ Pull-to-Refresh -->
            <RefreshView IsVisible="{Binding HasContracts}"
                         IsRefreshing="{Binding IsLoading}"
                         Command="{Binding LoadContractsCommand}">
                <CollectionView ItemsSource="{Binding Contracts}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedContract}"
                                Margin="0,4,12,0">
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:ContractItemViewModel">
                            <Frame Style="{StaticResource CardFrame}"
                                   Margin="0,0,0,12">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ContractsViewModel}}, Path=ViewContractCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>
                                
                                <VerticalStackLayout Spacing="12">
                                    
                                    <!-- Header Row -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding ContractNumber, StringFormat='â„– {0}'}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold"
                                                   TextColor="{DynamicResource Color.Text.Primary}"/>
                                            
                                            <Label Text="{Binding ClientName}" 
                                                   FontSize="14" 
                                                   TextColor="{DynamicResource Color.Text.Secondary}"
                                                   LineBreakMode="TailTruncation"/>
                                        </VerticalStackLayout>
                                        
                                        <Frame Grid.Column="1"
                                               Padding="12,6"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="{Binding StatusColor}"
                                               VerticalOptions="Start">
                                            <Label Text="{Binding Status}" 
                                                   FontSize="12" 
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                        </Frame>
                                    </Grid>

                                    <!-- Divider -->
                                    <BoxView HeightRequest="1" 
                                             BackgroundColor="{DynamicResource Color.Border}" 
                                             HorizontalOptions="FillAndExpand"/>

                                    <!-- Progress Section -->
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="10">
                                        
                                        <!-- ÐžÐ¿Ð»Ð°Ñ‚Ð° -->
                                        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                            <Label Grid.Column="0" 
                                                   Text="ðŸ’°" 
                                                   FontSize="16"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1" 
                                                   Text="ÐžÐ¿Ð»Ð°Ñ‚Ð°" 
                                                   FontSize="13"
                                                   TextColor="{DynamicResource Color.Text.Secondary}"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="2" 
                                                   Text="{Binding PaidPercent, StringFormat='{0:F0}%'}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="{DynamicResource Color.Text.Primary}"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <ProgressBar Grid.Row="1" 
                                                     Progress="{Binding PaidProgress}" 
                                                     ProgressColor="{DynamicResource Color.Primary}"
                                                     HeightRequest="6"/>

                                        <!-- ÐžÑ‚Ð³Ñ€ÑƒÐ·ÐºÐ° -->
                                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" Margin="0,4,0,0">
                                            <Label Grid.Column="0" 
                                                   Text="ðŸ“¦" 
                                                   FontSize="16"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1" 
                                                   Text="ÐžÑ‚Ð³Ñ€ÑƒÐ·ÐºÐ°" 
                                                   FontSize="13"
                                                   TextColor="{DynamicResource Color.Text.Secondary}"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="2" 
                                                   Text="{Binding ShippedPercent, StringFormat='{0:F0}%'}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="{DynamicResource Color.Text.Primary}"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <ProgressBar Grid.Row="3" 
                                                     Progress="{Binding ShippedProgress}" 
                                                     ProgressColor="{DynamicResource Color.Primary}"
                                                     HeightRequest="6"/>
                                    </Grid>

                                    <!-- Footer Info -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" Margin="0,4,0,0">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <!-- Ð”Ð»Ñ Open: Ð¡ÑƒÐ¼Ð¼Ð° = Ð¸Ð·Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²Ð°Ð½Ð¾ (ShippedAmount); Ð”Ð»Ñ Closed: Ð¡ÑƒÐ¼Ð¼Ð° = TotalAmount -->
                                            <Label Text="{Binding ItemsTotalForCard, StringFormat='Ð¡ÑƒÐ¼Ð¼Ð°: {0:N0} ÑÑƒÐ¼'}" 
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="{DynamicResource Color.Text.Primary}"/>
                                            
                                            <!-- ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº: Ð´Ð»Ñ Open â€” Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº Ð»Ð¸Ð¼Ð¸Ñ‚Ð°; Ð´Ð»Ñ Closed â€” Ð´Ð¾Ð»Ð³ -->
                                            <Label Text="{Binding RemainingForCard, StringFormat='ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº: {0:N0} ÑÑƒÐ¼'}" 
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding RemainingColor}"/>
                                        </VerticalStackLayout>
                                        
                                        <Label Grid.Column="1" 
                                               Text="{Binding CreatedAt, StringFormat='{0:dd.MM.yyyy}'}" 
                                               FontSize="12" 
                                               TextColor="{DynamicResource Color.Text.Tertiary}"
                                               VerticalOptions="End"/>
                                    </Grid>
                                    
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>

            <!-- ÐŸÑƒÑÑ‚Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ (Empty State) -->
            <VerticalStackLayout IsVisible="{Binding HasContracts, Converter={StaticResource InverseBoolConverter}}"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                Spacing="20">
                
                <Frame BackgroundColor="{DynamicResource Color.Surface}"
                       BorderColor="Transparent"
                       CornerRadius="80"
                       Padding="30"
                       HasShadow="False"
                       HorizontalOptions="Center">
                    <Label Text="ðŸ“„" 
                           FontSize="64"
                           HorizontalOptions="Center"
                           Opacity="0.6"/>
                </Frame>
                
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð²" 
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Color.Text.Primary}"
                           HorizontalOptions="Center"/>
                    
                    <Label Text="Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ" 
                           FontSize="14"
                           TextColor="{DynamicResource Color.Text.Secondary}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"
                           MaximumWidthRequest="300"/>
                </VerticalStackLayout>
                
                <Button Text="âž• Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€" 
                        Style="{StaticResource ActionButton}"
                        Command="{Binding CreateContractCommand}"
                        HorizontalOptions="Center"/>
                
            </VerticalStackLayout>
            
            <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ð¾Ð²ÐµÑ€Ñ… -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="{DynamicResource Color.Primary}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>
