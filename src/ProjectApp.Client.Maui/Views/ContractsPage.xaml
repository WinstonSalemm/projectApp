<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.ContractsPage"
             x:DataType="vm:ContractsViewModel"
             Title="Договора"
             BackgroundColor="#F5F7FA">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Современные стили кнопок -->
            <Style x:Key="TypeButton" TargetType="Button">
                <Setter Property="FontSize" Value="15"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HeightRequest" Value="56"/>
                <Setter Property="MinimumWidthRequest" Value="180"/>
                <Setter Property="Padding" Value="24,0"/>
                <Setter Property="Shadow">
                    <Shadow Brush="#40000000" Offset="0,4" Radius="12" Opacity="0.15"/>
                </Setter>
            </Style>
            
            <Style x:Key="ActionButton" TargetType="Button">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="HeightRequest" Value="44"/>
                <Setter Property="Padding" Value="20,0"/>
                <Setter Property="Shadow">
                    <Shadow Brush="#40000000" Offset="0,2" Radius="8" Opacity="0.12"/>
                </Setter>
            </Style>
            
            <Style x:Key="CardFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="BorderColor" Value="Transparent"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="Padding" Value="20"/>
                <Setter Property="HasShadow" Value="False"/>
                <Setter Property="Shadow">
                    <Shadow Brush="#20000000" Offset="0,2" Radius="16" Opacity="0.08"/>
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <Grid RowDefinitions="Auto,Auto,*" 
          Padding="16,12,16,16"
          RowSpacing="20">
        
        <!-- Тип договора - Современные кнопки с адаптивностью -->
        <FlexLayout Grid.Row="0" 
                    Direction="Row"
                    Wrap="Wrap"
                    JustifyContent="Center"
                    AlignItems="Center">
            
            <Button Text="📂 Открытые договора" 
                    Style="{StaticResource TypeButton}"
                    Command="{Binding SelectTypeCommand}"
                    CommandParameter="Open"
                    Margin="6"
                    BackgroundColor="{Binding SelectedType, Converter={StaticResource StringEqualToColorConverter}, ConverterParameter=Open}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" 
                                 Binding="{Binding SelectedType}" 
                                 Value="Open">
                        <Setter Property="Scale" Value="1.02"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            
            <Button Text="📋 Закрытые договора" 
                    Style="{StaticResource TypeButton}"
                    Command="{Binding SelectTypeCommand}"
                    CommandParameter="Closed"
                    Margin="6"
                    BackgroundColor="{Binding SelectedType, Converter={StaticResource StringEqualToColorConverter}, ConverterParameter=Closed}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" 
                                 Binding="{Binding SelectedType}" 
                                 Value="Closed">
                        <Setter Property="Scale" Value="1.02"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
        </FlexLayout>

        <!-- Toolbar - Улучшенные кнопки действий -->
        <FlexLayout Grid.Row="1" 
                    Direction="Row"
                    Wrap="Wrap"
                    JustifyContent="Start"
                    AlignItems="Center">
            
            <Button Text="➕ Создать договор" 
                    Style="{StaticResource ActionButton}"
                    Command="{Binding CreateContractCommand}"
                    Margin="0,0,12,0"
                    BackgroundColor="#10B981"/>
            
            <Button Text="🔄 Обновить" 
                    Style="{StaticResource ActionButton}"
                    Command="{Binding LoadContractsCommand}"
                    BackgroundColor="#3B82F6"/>
        </FlexLayout>

        <!-- Контейнер для списка и пустого состояния -->
        <Grid Grid.Row="2">
            
            <!-- Список договоров с Pull-to-Refresh -->
            <RefreshView IsVisible="{Binding HasContracts}"
                         IsRefreshing="{Binding IsLoading}"
                         Command="{Binding LoadContractsCommand}">
                <CollectionView ItemsSource="{Binding Contracts}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedContract}"
                                Margin="0,4,0,0">
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:ContractItemViewModel">
                            <Frame Style="{StaticResource CardFrame}"
                                   Margin="0,0,0,12">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ContractsViewModel}}, Path=ViewContractCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>
                                
                                <VerticalStackLayout Spacing="12">
                                    
                                    <!-- Header Row -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding ContractNumber, StringFormat='№ {0}'}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold"
                                                   TextColor="#1F2937"/>
                                            
                                            <Label Text="{Binding ClientName}" 
                                                   FontSize="14" 
                                                   TextColor="#6B7280"
                                                   LineBreakMode="TailTruncation"/>
                                        </VerticalStackLayout>
                                        
                                        <Frame Grid.Column="1"
                                               Padding="12,6"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="{Binding StatusColor}"
                                               VerticalOptions="Start">
                                            <Label Text="{Binding Status}" 
                                                   FontSize="12" 
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                        </Frame>
                                    </Grid>

                                    <!-- Divider -->
                                    <BoxView HeightRequest="1" 
                                             BackgroundColor="#E5E7EB" 
                                             HorizontalOptions="FillAndExpand"/>

                                    <!-- Progress Section -->
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="10">
                                        
                                        <!-- Оплата -->
                                        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                            <Label Grid.Column="0" 
                                                   Text="💰" 
                                                   FontSize="16"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1" 
                                                   Text="Оплата" 
                                                   FontSize="13"
                                                   TextColor="#6B7280"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="2" 
                                                   Text="{Binding PaidPercent, StringFormat='{0:F0}%'}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="#10B981"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <ProgressBar Grid.Row="1" 
                                                     Progress="{Binding PaidProgress}" 
                                                     ProgressColor="#10B981"
                                                     HeightRequest="6"/>

                                        <!-- Отгрузка -->
                                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" Margin="0,4,0,0">
                                            <Label Grid.Column="0" 
                                                   Text="📦" 
                                                   FontSize="16"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1" 
                                                   Text="Отгрузка" 
                                                   FontSize="13"
                                                   TextColor="#6B7280"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="2" 
                                                   Text="{Binding ShippedPercent, StringFormat='{0:F0}%'}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="#3B82F6"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <ProgressBar Grid.Row="3" 
                                                     Progress="{Binding ShippedProgress}" 
                                                     ProgressColor="#3B82F6"
                                                     HeightRequest="6"/>
                                    </Grid>

                                    <!-- Footer Info -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" Margin="0,4,0,0">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <!-- Для Open: Сумма = израсходовано (ShippedAmount); Для Closed: Сумма = TotalAmount -->
                                            <Label Text="{Binding ItemsTotalForCard, StringFormat='Сумма: {0:N0} сум'}" 
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="#1F2937"/>
                                            
                                            <!-- Остаток: для Open — остаток лимита; для Closed — долг -->
                                            <Label Text="{Binding RemainingForCard, StringFormat='Остаток: {0:N0} сум'}" 
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding RemainingColor}"/>
                                        </VerticalStackLayout>
                                        
                                        <Label Grid.Column="1" 
                                               Text="{Binding CreatedAt, StringFormat='{0:dd.MM.yyyy}'}" 
                                               FontSize="12" 
                                               TextColor="#9CA3AF"
                                               VerticalOptions="End"/>
                                    </Grid>
                                    
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>

            <!-- Пустое состояние (Empty State) -->
            <VerticalStackLayout IsVisible="{Binding HasContracts, Converter={StaticResource InverseBoolConverter}}"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                Spacing="20">
                
                <Frame BackgroundColor="White"
                       BorderColor="Transparent"
                       CornerRadius="80"
                       Padding="30"
                       HasShadow="False"
                       HorizontalOptions="Center">
                    <Label Text="📄" 
                           FontSize="64"
                           HorizontalOptions="Center"
                           Opacity="0.6"/>
                </Frame>
                
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Label Text="Нет активных договоров" 
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="#1F2937"
                           HorizontalOptions="Center"/>
                    
                    <Label Text="Создайте первый договор, чтобы начать работу" 
                           FontSize="14"
                           TextColor="#9CA3AF"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"
                           MaximumWidthRequest="300"/>
                </VerticalStackLayout>
                
                <Button Text="➕ Создать первый договор" 
                        Style="{StaticResource ActionButton}"
                        Command="{Binding CreateContractCommand}"
                        BackgroundColor="#10B981"
                        HorizontalOptions="Center"/>
                
            </VerticalStackLayout>
            
            <!-- Индикатор загрузки поверх -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="#660000"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>
