<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.FinanceAnalyticsPage"
             x:DataType="vm:AnalyticsViewModel"
             Title="Финансовая аналитика"
             BackgroundColor="{DynamicResource Color.Background}">
  
  <ScrollView Padding="16">
    <VerticalStackLayout Spacing="16">
      <Label Text="📊 Финансовая аналитика" FontSize="24" FontAttributes="Bold" Margin="0,0,0,8"/>
      
      <!-- Переключатель периода -->
      <HorizontalStackLayout Spacing="12" Margin="0,0,0,16">
        <Border x:Name="PeriodMonth" Padding="16,8" BackgroundColor="{DynamicResource Color.Primary}" StrokeThickness="0" StrokeShape="RoundRectangle 20">
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnMonthTapped"/>
          </Border.GestureRecognizers>
          <Label Text="Месяц" TextColor="White" FontSize="14" FontAttributes="Bold"/>
        </Border>
        
        <Border x:Name="PeriodYear" Padding="16,8" BackgroundColor="Transparent" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" StrokeShape="RoundRectangle 20">
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnYearTapped"/>
          </Border.GestureRecognizers>
          <Label Text="Год" TextColor="{DynamicResource Color.Text.Primary}" FontSize="14"/>
        </Border>
        
        <Border Padding="16,8" BackgroundColor="Transparent" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" StrokeShape="RoundRectangle 20">
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnRefreshTapped"/>
          </Border.GestureRecognizers>
          <Label Text="🔄 Обновить" TextColor="{DynamicResource Color.Text.Primary}" FontSize="14"/>
        </Border>
      </HorizontalStackLayout>
      
      <!-- KPI карточки -->
      <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="12">
        <!-- Выручка -->
        <Border Grid.Row="0" Grid.Column="0" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
          <VerticalStackLayout Spacing="8">
            <Label Text="💰 Выручка" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            <Label Text="{Binding FinanceRevenue, StringFormat='{0:N0} сум'}" FontSize="20" FontAttributes="Bold"/>
          </VerticalStackLayout>
        </Border>
        
        <!-- Валовая прибыль -->
        <Border Grid.Row="0" Grid.Column="1" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
          <VerticalStackLayout Spacing="8">
            <Label Text="📈 Вал. прибыль" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            <Label Text="{Binding FinanceGrossProfit, StringFormat='{0:N0} сум'}" FontSize="20" FontAttributes="Bold" TextColor="{DynamicResource Color.Success}"/>
          </VerticalStackLayout>
        </Border>
        
        <!-- Маржа -->
        <Border Grid.Row="1" Grid.Column="0" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
          <VerticalStackLayout Spacing="8">
            <Label Text="🎯 Маржа" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            <Label Text="{Binding FinanceMargin, StringFormat='{0:F1}%'}" FontSize="20" FontAttributes="Bold" TextColor="{DynamicResource Color.Primary}"/>
          </VerticalStackLayout>
        </Border>
        
        <!-- Продаж -->
        <Border Grid.Row="1" Grid.Column="1" StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" StrokeShape="RoundRectangle 12">
          <VerticalStackLayout Spacing="8">
            <Label Text="🛒 Продаж" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            <Label Text="{Binding FinanceSalesCount}" FontSize="20" FontAttributes="Bold"/>
          </VerticalStackLayout>
        </Border>
      </Grid>
      
      <!-- Структура (вертикальный анализ) -->
      <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" Padding="16" Margin="0,8,0,0" StrokeShape="RoundRectangle 12">
        <VerticalStackLayout Spacing="12">
          <Label Text="📊 Структура выручки" FontSize="18" FontAttributes="Bold"/>
          
          <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="8">
            <!-- Себестоимость -->
            <Label Grid.Row="0" Grid.Column="0" Text="💸 Себестоимость:" FontSize="14" VerticalTextAlignment="Center"/>
            <ProgressBar Grid.Row="0" Grid.Column="1" Progress="{Binding FinanceCostPercent}" ProgressColor="{DynamicResource Color.Error}" HeightRequest="20" VerticalOptions="Center"/>
            <Label Grid.Row="0" Grid.Column="2" Text="{Binding FinanceCostPercent, StringFormat='{0:P0}'}" FontSize="14" FontAttributes="Bold" VerticalTextAlignment="Center"/>
            
            <!-- Валовая прибыль -->
            <Label Grid.Row="1" Grid.Column="0" Text="✅ Вал. прибыль:" FontSize="14" VerticalTextAlignment="Center"/>
            <ProgressBar Grid.Row="1" Grid.Column="1" Progress="{Binding FinanceProfitPercent}" ProgressColor="{DynamicResource Color.Success}" HeightRequest="20" VerticalOptions="Center"/>
            <Label Grid.Row="1" Grid.Column="2" Text="{Binding FinanceProfitPercent, StringFormat='{0:P0}'}" FontSize="14" FontAttributes="Bold" VerticalTextAlignment="Center"/>
          </Grid>
        </VerticalStackLayout>
      </Border>
      
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>
