<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.FinanceAnalyticsPage"
             x:DataType="vm:AnalyticsViewModel"
             Title="Финансовая аналитика"
             BackgroundColor="{DynamicResource Color.Background}">
  <Grid Padding="20">
    <RefreshView IsRefreshing="{Binding IsLoading}" Command="{Binding LoadFinanceKpiCommand}">
      <ScrollView>
        <VerticalStackLayout Spacing="16">
          <!-- Заголовок -->
          <HorizontalStackLayout HorizontalOptions="Fill" VerticalOptions="Center" Spacing="12">
            <Label Text="Финансовая аналитика" FontSize="20" FontAttributes="Bold" TextColor="{DynamicResource Color.Text.Primary}"/>
            <Label Text="{Binding PeriodLabel}" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            <Button Text="Обновить" Command="{Binding LoadFinanceKpiCommand}" />
          </HorizontalStackLayout>

          <!-- Переключатели периода -->
          <HorizontalStackLayout Spacing="10">
            <Button Text="Месяц" Command="{Binding SetPeriodCommand}" CommandParameter="month">
              <Button.Style>
                <Style TargetType="Button" BasedOn="{StaticResource Button.Secondary}">
                  <Setter Property="BackgroundColor" Value="{DynamicResource Color.Surface.Muted}" />
                  <Setter Property="TextColor" Value="{DynamicResource Color.Text.Secondary}" />
                  <Style.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Period}" Value="month">
                      <Setter Property="BackgroundColor" Value="{DynamicResource Color.Primary}" />
                      <Setter Property="TextColor" Value="{DynamicResource Color.OnPrimary}" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>
            <Button Text="Год" Command="{Binding SetPeriodCommand}" CommandParameter="year">
              <Button.Style>
                <Style TargetType="Button" BasedOn="{StaticResource Button.Secondary}">
                  <Setter Property="BackgroundColor" Value="{DynamicResource Color.Surface.Muted}" />
                  <Setter Property="TextColor" Value="{DynamicResource Color.Text.Secondary}" />
                  <Style.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Period}" Value="year">
                      <Setter Property="BackgroundColor" Value="{DynamicResource Color.Primary}" />
                      <Setter Property="TextColor" Value="{DynamicResource Color.OnPrimary}" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>
            <Button Text="Диапазон" Command="{Binding SetPeriodCommand}" CommandParameter="custom">
              <Button.Style>
                <Style TargetType="Button" BasedOn="{StaticResource Button.Secondary}">
                  <Setter Property="BackgroundColor" Value="{DynamicResource Color.Surface.Muted}" />
                  <Setter Property="TextColor" Value="{DynamicResource Color.Text.Secondary}" />
                  <Style.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Period}" Value="custom">
                      <Setter Property="BackgroundColor" Value="{DynamicResource Color.Primary}" />
                      <Setter Property="TextColor" Value="{DynamicResource Color.OnPrimary}" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>
          </HorizontalStackLayout>

          <!-- Произвольный диапазон -->
          <Grid IsVisible="False">
            <Grid.Style>
              <Style TargetType="Grid">
                <Style.Triggers>
                  <DataTrigger TargetType="Grid" Binding="{Binding Period}" Value="custom">
                    <Setter Property="IsVisible" Value="True" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Grid.Style>

            <Grid ColumnDefinitions="Auto,*,Auto,*,Auto" ColumnSpacing="8">
              <Label Grid.Column="0" Text="с" VerticalTextAlignment="Center" TextColor="{DynamicResource Color.Text.Secondary}"/>
              <DatePicker Grid.Column="1" Date="{Binding DateFrom}" />
              <Label Grid.Column="2" Text="по" VerticalTextAlignment="Center" TextColor="{DynamicResource Color.Text.Secondary}"/>
              <DatePicker Grid.Column="3" Date="{Binding DateTo}" />
              <Button Grid.Column="4" Text="Показать" Command="{Binding LoadCustomRangeCommand}"/>
            </Grid>
          </Grid>

          <!-- Карточка KPI: оборот и количество продаж -->
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" StrokeShape="RoundRectangle 12" Padding="20">
            <VerticalStackLayout Spacing="6">
              <Label Text="Оборот" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
              <Label Text="{Binding FinanceRevenue, Converter={StaticResource CurrencyConverter}}" FontSize="32" FontAttributes="Bold" TextColor="{DynamicResource Color.Text.Primary}"/>
              <Label Text="{Binding FinanceSalesCount, StringFormat='Количество продаж: {0}'}" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
            </VerticalStackLayout>
          </Border>

          <!-- ND→IM CASH FLOW -->
          <Border StrokeThickness="1" Stroke="{DynamicResource Color.Border}" BackgroundColor="{DynamicResource Color.Surface}" StrokeShape="RoundRectangle 12" Padding="20">
            <VerticalStackLayout Spacing="6">
              <Label Text="ND→IM CASH FLOW" FontSize="14" TextColor="{DynamicResource Color.Text.Secondary}"/>
              <Label Text="{Binding NdImCashFlow, Converter={StaticResource CurrencyConverter}}" FontSize="28" FontAttributes="Bold" TextColor="{DynamicResource Color.Error}"/>
              <Label Text="Сумма корректировок по ND→IM за период" FontSize="12" TextColor="{DynamicResource Color.Text.Secondary}"/>
            </VerticalStackLayout>
          </Border>

          <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}"/>
        </VerticalStackLayout>
      </ScrollView>
    </RefreshView>
  </Grid>
</ContentPage>
