<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.SuppliesPage"
             Title="Поставки (ND-40 / IM-40)"
             x:DataType="vm:SuppliesViewModel">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Создать поставку" 
                     Clicked="OnCreateSupplyClicked"
                     IconImageSource="add.png"/>
        <ToolbarItem Text="Обновить" 
                     Clicked="OnRefreshClicked"
                     IconImageSource="refresh.png"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*" Padding="10">
        
        <!-- Табы: ND-40 / IM-40 -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" Margin="0,0,0,10">
            <Button Grid.Column="0" 
                    Text="📦 ND-40" 
                    Command="{Binding SelectTabCommand}" 
                    CommandParameter="ND40"
                    BackgroundColor="{Binding CurrentTab, Converter={StaticResource TabToColorConverter}, ConverterParameter='ND40'}"
                    TextColor="White"
                    FontAttributes="Bold"
                    Margin="0,0,5,0"/>
            
            <Button Grid.Column="1" 
                    Text="📦 IM-40" 
                    Command="{Binding SelectTabCommand}" 
                    CommandParameter="IM40"
                    BackgroundColor="{Binding CurrentTab, Converter={StaticResource TabToColorConverter}, ConverterParameter='IM40'}"
                    TextColor="White"
                    FontAttributes="Bold"
                    Margin="5,0,0,0"/>
        </Grid>

        <!-- Список поставок ND-40 -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Nd40Supplies}"
                        SelectionMode="None"
                        IsVisible="{Binding IsNd40Visible}">
            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20">
                    <Label Text="Нет поставок" 
                           FontSize="18" 
                           TextColor="Gray" 
                           HorizontalTextAlignment="Center"/>
                    <Label Text="Создайте первую поставку +" 
                           FontSize="14" 
                           TextColor="LightGray" 
                           HorizontalTextAlignment="Center"
                           Margin="0,10,0,0"/>
                </StackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="services:SupplyDto">
                    <Frame Margin="0,5" 
                           Padding="15" 
                           CornerRadius="8" 
                           HasShadow="True"
                           BorderColor="LightGray">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                            
                            <!-- Заголовок -->
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding Code}" 
                                   FontSize="18" 
                                   FontAttributes="Bold"/>
                            
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Status, Converter={StaticResource SupplyStatusConverter}}"
                                   FontSize="12"
                                   TextColor="{Binding Status, Converter={StaticResource SupplyStatusColorConverter}}"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>

                            <!-- Детали -->
                            <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding RegisterType, StringFormat='Регистр: {0}'}"
                                   FontSize="14"
                                   TextColor="Gray"
                                   Margin="0,5,0,0"/>

                            <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding CreatedAt, StringFormat='Создано: {0:dd.MM.yyyy HH:mm}'}"
                                   FontSize="12"
                                   TextColor="Gray"/>

                            <!-- Кнопки действий -->
                            <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                  ColumnDefinitions="*,*,*,*" 
                                  Margin="0,10,0,0">
                                
                                <!-- Редактировать -->
                                <Button Grid.Column="0" 
                                        Text="✏️" 
                                        Clicked="OnEditSupplyClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="0,0,2,0"
                                        BackgroundColor="#3498db"
                                        TextColor="White"/>

                                <!-- Удалить -->
                                <Button Grid.Column="1" 
                                        Text="🗑️" 
                                        Clicked="OnDeleteSupplyClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="2,0"
                                        BackgroundColor="#e74c3c"
                                        TextColor="White"/>

                                <!-- Перевести в IM-40 (только для ND-40) -->
                                <Button Grid.Column="2" 
                                        Text="➡️ IM" 
                                        Clicked="OnTransferToIm40Clicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="2,0"
                                        BackgroundColor="#f39c12"
                                        TextColor="White"
                                        IsVisible="{Binding RegisterType, Converter={StaticResource IsNd40Converter}}"/>

                                <!-- Расчёт себестоимости -->
                                <Button Grid.Column="3" 
                                        Text="💰" 
                                        Clicked="OnOpenCostingClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="2,0,0,0"
                                        BackgroundColor="#27ae60"
                                        TextColor="White"/>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Список поставок IM-40 -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Im40Supplies}"
                        SelectionMode="None"
                        IsVisible="{Binding IsIm40Visible}">
            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20">
                    <Label Text="Нет поставок" 
                           FontSize="18" 
                           TextColor="Gray" 
                           HorizontalTextAlignment="Center"/>
                    <Label Text="Создайте первую поставку +" 
                           FontSize="14" 
                           TextColor="LightGray" 
                           HorizontalTextAlignment="Center"
                           Margin="0,10,0,0"/>
                </StackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="services:SupplyDto">
                    <Frame Margin="0,5" 
                           Padding="15" 
                           CornerRadius="8" 
                           HasShadow="True"
                           BorderColor="LightGray">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                            
                            <!-- Заголовок -->
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding Code}" 
                                   FontSize="18" 
                                   FontAttributes="Bold"/>
                            
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Status, Converter={StaticResource SupplyStatusConverter}}"
                                   FontSize="12"
                                   TextColor="{Binding Status, Converter={StaticResource SupplyStatusColorConverter}}"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>

                            <!-- Детали -->
                            <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding RegisterType, StringFormat='Регистр: {0}'}"
                                   FontSize="14"
                                   TextColor="Gray"
                                   Margin="0,5,0,0"/>

                            <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding CreatedAt, StringFormat='Создано: {0:dd.MM.yyyy HH:mm}'}"
                                   FontSize="12"
                                   TextColor="Gray"/>

                            <!-- Кнопки действий -->
                            <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                  ColumnDefinitions="*,*,*" 
                                  Margin="0,10,0,0">
                                
                                <!-- Редактировать -->
                                <Button Grid.Column="0" 
                                        Text="✏️" 
                                        Clicked="OnEditSupplyClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="0,0,2,0"
                                        BackgroundColor="#3498db"
                                        TextColor="White"/>

                                <!-- Удалить -->
                                <Button Grid.Column="1" 
                                        Text="🗑️" 
                                        Clicked="OnDeleteSupplyClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="2,0"
                                        BackgroundColor="#e74c3c"
                                        TextColor="White"/>

                                <!-- Расчёт себестоимости -->
                                <Button Grid.Column="2" 
                                        Text="💰" 
                                        Clicked="OnOpenCostingClicked"
                                        BindingContext="{Binding .}"
                                        FontSize="12"
                                        Padding="5"
                                        Margin="2,0,0,0"
                                        BackgroundColor="#27ae60"
                                        TextColor="White"/>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Loading indicator -->
        <ActivityIndicator Grid.Row="1" 
                          IsRunning="{Binding IsBusy}" 
                          IsVisible="{Binding IsBusy}"
                          Color="Blue"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"/>
    </Grid>
</ContentPage>
