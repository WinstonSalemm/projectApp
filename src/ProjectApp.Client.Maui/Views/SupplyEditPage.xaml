<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.SupplyEditPage"
             Title="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸"
             x:DataType="{x:Null}">
    <!-- ===== RESOURCES / STYLES ===== -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Ð¢Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÑ‚Ð¸Ð»Ð¸ -->
            <Style x:Key="TableHeaderLabel"
                   TargetType="Label">
                <Setter Property="FontAttributes"
                        Value="Bold" />
                <Setter Property="FontSize"
                        Value="12" />
                <Setter Property="Padding"
                        Value="8,6" />
                <Setter Property="BackgroundColor"
                        Value="#ecf0f1" />
                <Setter Property="TextColor"
                        Value="#2c3e50" />
                <Setter Property="LineBreakMode"
                        Value="TailTruncation" />
            </Style>
            <Style x:Key="CellLabel"
                   TargetType="Label">
                <Setter Property="FontSize"
                        Value="12" />
                <Setter Property="Padding"
                        Value="8,6" />
                <Setter Property="LineBreakMode"
                        Value="TailTruncation" />
                <Setter Property="VerticalTextAlignment"
                        Value="Center" />
            </Style>
            <Style x:Key="CellMuted"
                   TargetType="Label"
                   BasedOn="{StaticResource CellLabel}">
                <Setter Property="FontSize"
                        Value="11" />
                <Setter Property="TextColor"
                        Value="Gray" />
            </Style>
            <Style x:Key="CellNum"
                   TargetType="Label"
                   BasedOn="{StaticResource CellLabel}">
                <Setter Property="HorizontalTextAlignment"
                        Value="End" />
            </Style>
            <Style x:Key="CellBorder"
                   TargetType="Border">
                <Setter Property="Stroke"
                        Value="#d1d5db" />
                <Setter Property="StrokeThickness"
                        Value="1" />
            </Style>
            <Style x:Key="FieldLabel"
                   TargetType="Label">
                <Setter Property="VerticalTextAlignment"
                        Value="Center" />
                <Setter Property="FontSize"
                        Value="13" />
            </Style>
            <Style x:Key="FieldEntry"
                   TargetType="Entry">
                <Setter Property="Keyboard"
                        Value="Numeric" />
                <Setter Property="FontSize"
                        Value="13" />
                <Setter Property="HeightRequest"
                        Value="36" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    <!-- ===== TOOLBAR ===== -->
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€"
                     Clicked="OnAddProductClicked"
                     IconImageSource="add.png" />
        <ToolbarItem Text="ðŸ”„ ÐŸÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ"
                     Clicked="OnRecalculateClicked" />
    </ContentPage.ToolbarItems>
    <!-- ===== PAGE ===== -->
    <ScrollView>
        <VerticalStackLayout Padding="10"
                             Spacing="10">
            <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ -->
            <Frame BorderColor="LightGray"
                   CornerRadius="8"
                   Padding="12"
                   Margin="0,0,0,4">
                <Grid RowDefinitions="Auto,Auto"
                      ColumnDefinitions="*,Auto"
                      ColumnSpacing="8">
                    <Label Grid.Row="0"
                           Grid.Column="0"
                           Text="{Binding Supply.Code, StringFormat='ÐŸÐ¾ÑÑ‚Ð°Ð²ÐºÐ°: {0}', FallbackValue='ÐŸÐ¾ÑÑ‚Ð°Ð²ÐºÐ°: â€¦'}"
                           FontSize="20"
                           FontAttributes="Bold" />
                    <Label Grid.Row="1"
                           Grid.Column="0"
                           Text="{Binding Supply.RegisterType, StringFormat='Ð ÐµÐ³Ð¸ÑÑ‚Ñ€: {0}', FallbackValue='Ð ÐµÐ³Ð¸ÑÑ‚Ñ€: â€¦'}"
                           FontSize="13"
                           TextColor="Gray" />
                </Grid>
            </Frame>
            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² -->
            <Label Text="Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð² Ð¿Ð¾ÑÑ‚Ð°Ð²ÐºÐµ:"
                   FontSize="16"
                   FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding SupplyItems}"
                            SelectionMode="None"
                            HeightRequest="240">
                <CollectionView.EmptyView>
                    <Label Text="ÐÐµÑ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð². ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ '+' Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ."
                           TextColor="Gray"
                           HorizontalTextAlignment="Center"
                           Margin="0,12,0,0" />
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="services:SupplyItemDto">
                        <Frame Margin="0,6"
                               Padding="10"
                               BorderColor="LightGray">
                            <Grid RowDefinitions="Auto,Auto,Auto"
                                  ColumnDefinitions="*,Auto"
                                  ColumnSpacing="8">
                                <Label Grid.Row="0"
                                       Grid.Column="0"
                                       Text="{Binding Name}"
                                       FontSize="15"
                                       FontAttributes="Bold" />
                                <Button Grid.Row="0"
                                        Grid.Column="1"
                                        Text="ðŸ—‘ï¸"
                                        Clicked="OnRemoveProductClicked"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#e74c3c"
                                        TextColor="White"
                                        WidthRequest="36"
                                        HeightRequest="36" />
                                <Label Grid.Row="1"
                                       Grid.Column="0"
                                       Grid.ColumnSpan="2"
                                       Text="{Binding Sku, StringFormat='SKU: {0}'}"
                                       FontSize="12"
                                       TextColor="Gray" />
                                <Grid Grid.Row="2"
                                      Grid.Column="0"
                                      Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,*,*"
                                      ColumnSpacing="8"
                                      Margin="0,4,0,0">
                                    <Label Grid.Column="0"
                                           Text="{Binding Quantity, StringFormat='ÐšÐ¾Ð»-Ð²Ð¾: {0}'}"
                                           FontSize="12" />
                                    <Label Grid.Column="1"
                                           Text="{Binding PriceRub, StringFormat='Ð¦ÐµÐ½Ð°: {0:F2} â‚½'}"
                                           FontSize="12" />
                                    <Label Grid.Column="2"
                                           Text="{Binding Weight, StringFormat='Ð’ÐµÑ: {0:F2} ÐºÐ³'}"
                                           FontSize="12" />
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <!-- Ð¡ÐµÐºÑ†Ð¸Ñ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð° (Ð½Ð¾Ð²Ð°Ñ) -->
            <Frame BackgroundColor="#2563eb" Padding="12" CornerRadius="8">
                <Label Text="ðŸ’° Ð ÐÐ¡Ð§ÐÐ¢ Ð¡Ð•Ð‘Ð•Ð¡Ð¢ÐžÐ˜ÐœÐžÐ¡Ð¢Ð˜" TextColor="White" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center" />
            </Frame>
            <ContentView x:Name="CostingSection">
                <ContentView.Content>
                    <VerticalStackLayout Spacing="10"
                                          BindingContext="{Binding Source={x:Reference CostingSection}, Path=BindingContext}">
                        <!-- Excel-like parameter grid -->
                        <Grid ColumnDefinitions="180,180,180,180,180"
                              RowDefinitions="Auto,Auto,Auto"
                              ColumnSpacing="0" RowSpacing="0">
                            <!-- Row 0 -->
                            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="RUBâ†’UZS" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding RubToUzs, Mode=TwoWay}" Placeholder="156"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="USDâ†’UZS" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding UsdToUzs, Mode=TwoWay}" Placeholder="12800"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="0" Grid.Column="2" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="Ð¢Ð°Ð¼Ð¾Ð¶Ð½Ñ (UZS)" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding CustomsFixedUzs, Mode=TwoWay}" Placeholder="0"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="0" Grid.Column="3" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐŸÐ¾Ð³Ñ€ÑƒÐ·ÐºÐ° (UZS)" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding LoadingTotalUzs, Mode=TwoWay}" Placeholder="0"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="0" Grid.Column="4" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐÐ°Ñ†ÐµÐ½ÐºÐ°" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding TradeMarkupPct, Mode=TwoWay}" Placeholder="0.15 = 15%"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Row 1 -->
                            <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ°" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding LogisticsPct, Mode=TwoWay}" Placeholder="0.05 = 5%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="Ð¡ÐºÐ»Ð°Ð´" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding WarehousePct, Mode=TwoWay}" Placeholder="0.005 = 0.5%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="1" Grid.Column="2" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="Ð”ÐµÐºÐ»" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding DeclarationPct, Mode=TwoWay}" Placeholder="0.002 = 0.2%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="1" Grid.Column="3" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="Ð¡ÐµÑ€Ñ‚Ð¸Ñ„" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding CertificationPct, Mode=TwoWay}" Placeholder="0.01 = 1%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="1" Grid.Column="4" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐœÐ§Ð¡" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding McsPct, Mode=TwoWay}" Placeholder="0.01 = 1%"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Row 2 -->
                            <Border Grid.Row="2" Grid.Column="0" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐžÑ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding DeviationPct, Mode=TwoWay}" Placeholder="0.015 = 1.5%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="2" Grid.Column="1" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐÐ”Ð¡" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding VatPct, Mode=TwoWay}" Placeholder="0.16 = 16%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="2" Grid.Column="2" Style="{StaticResource CellBorder}" Padding="6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Style="{StaticResource FieldLabel}" Text="ÐÐ°Ð»Ð¾Ð³ Ð½Ð° Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ" TextColor="Gray"/>
                                    <Entry Style="{StaticResource FieldEntry}" HorizontalTextAlignment="End" Text="{Binding ProfitTaxPct, Mode=TwoWay}" Placeholder="0.15 = 15%"/>
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Row="2" Grid.Column="3" Grid.ColumnSpan="2" Style="{StaticResource CellBorder}" Padding="6">
                                <Button Text="ÐŸÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ" Command="{Binding RecalculateAsyncCommand}" HorizontalOptions="Fill"/>
                            </Border>
                        </Grid>

                        <!-- Warnings from server / calculation -->
                        <VerticalStackLayout Spacing="6" Margin="0,8,0,0">
                            <Border IsVisible="{Binding HasWarnings}" BackgroundColor="#332200" Stroke="#CC9900" StrokeThickness="1" Padding="8" StrokeShape="RoundRectangle 6">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ" FontAttributes="Bold" TextColor="#FFCC00"/>
                                    <CollectionView ItemsSource="{Binding Warnings}" SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Label Text="{Binding}" TextColor="#FFDD66"/>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Ð›ÐµÐ³ÐµÐ½Ð´Ð° Ð¿Ð¾ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ð¼ -->
                        <Label Text="ÐŸÐ¾ÑÑÐ½ÐµÐ½Ð¸Ñ: Ð¢Ð°Ð¼Ð¾Ð¶/ÐŸÐ¾Ð³Ñ€ÑƒÐ· â€” Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚ Ð½Ð° ÑˆÑ‚. ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ â€” Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ Ð¾Ñ‚ Ð±Ð°Ð·Ñ‹, Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ñ‹ Ð² UZS/ÑˆÑ‚. 'Ð¡ÐµÐ±ÐµÑ/ÑˆÑ‚' â€” ÑÑƒÐ¼Ð¼Ð° Ð²ÑÐµÑ… Ð·Ð°Ñ‚Ñ€Ð°Ñ‚ Ð½Ð° ÑˆÑ‚. 'Ð˜Ñ‚Ð¾Ð³Ð¾ (UZS)' â€” ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ (Ð¡ÐµÐ±ÐµÑ/ÑˆÑ‚ Ã— ÐšÐ¾Ð»-Ð²Ð¾)."
                               FontSize="12" TextColor="Gray"/>

                        <!-- Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ -->
                        <Grid ColumnDefinitions="*,Auto,Auto" Margin="0,6,0,6">
                            <Label Grid.Column="0" Text=""/>
                            <Button Grid.Column="1" Text="â†" WidthRequest="36" Clicked="OnScrollLeftClicked" />
                            <Button Grid.Column="2" Text="â†’" WidthRequest="36" Clicked="OnScrollRightClicked" />
                        </Grid>

                        <!-- Horizontal-only scroll to avoid nested ScrollView conflicts -->
                        <ScrollView x:Name="TableScroll" Orientation="Horizontal" HorizontalScrollBarVisibility="Always" VerticalScrollBarVisibility="Never">
                            <Grid MinimumWidthRequest="2200" WidthRequest="2200" HorizontalOptions="Start">
                                <!-- Purchase-only columns: #, Name, Qty, Base, Customs, Loading, Logistics, Warehouse, Declaration, Certification, MChs, Deviation, Cost/Unit, Line Total -->
                                <Grid RowDefinitions="Auto,Auto,*,Auto" ColumnDefinitions="40,240,90,110,110,110,110,110,110,110,110,110,120,140" ColumnSpacing="0" MinimumWidthRequest="2200" WidthRequest="2200" HorizontalOptions="Start">
                                    <!-- Group headers row -->
                                    <Grid Grid.Row="0" ColumnSpacing="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="240"/>
                                            <ColumnDefinition Width="90"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Grid.Column="3" BackgroundColor="#FFF3BF" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð‘Ð°Ð·Ð°"/></Border>
                                        <Border Grid.Column="4" Grid.ColumnSpan="2" BackgroundColor="#FFD6D6" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ñ‹ Ð½Ð° ÑˆÑ‚"/></Border>
                                        <Border Grid.Column="6" Grid.ColumnSpan="6" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ Ð¾Ñ‚ Ð±Ð°Ð·Ñ‹"/></Border>
                                        <Border Grid.Column="12" BackgroundColor="#D9F7BE" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð¡ÐµÐ±ÐµÑ/ÑˆÑ‚"/></Border>
                                        <Border Grid.Column="13" BackgroundColor="#E6E6E6" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð˜Ñ‚Ð¾Ð³Ð¾"/></Border>
                                    </Grid>

                                    <!-- Column headers row -->
                                    <Grid Grid.Row="1" ColumnSpacing="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="240"/>
                                            <ColumnDefinition Width="90"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="#"/></Border>
                                        <Border Grid.Column="1" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ"/></Border>
                                        <Border Grid.Column="2" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="ÐšÐ¾Ð»-Ð²Ð¾" HorizontalTextAlignment="End"/></Border>
                                        <Border Grid.Column="3" BackgroundColor="#FFF3BF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð‘Ð°Ð·Ð° (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="4" BackgroundColor="#FFD6D6" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð¢Ð°Ð¼Ð¾Ð¶ (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="Ð°Ð±Ñ." HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="5" BackgroundColor="#FFD6D6" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="ÐŸÐ¾Ð³Ñ€ÑƒÐ· (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="Ð°Ð±Ñ." HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="6" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ° (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding LogisticsPct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="7" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð¡ÐºÐ»Ð°Ð´ (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding WarehousePct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="8" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð”ÐµÐºÐ» (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding DeclarationPct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="9" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="Ð¡ÐµÑ€Ñ‚Ð¸Ñ„ (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding CertificationPct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="10" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="ÐœÐ§Ð¡ (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding McsPct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="11" BackgroundColor="#D0E8FF" Style="{StaticResource CellBorder}">
                                            <VerticalStackLayout Spacing="0">
                                                <Label Style="{StaticResource TableHeaderLabel}" Text="ÐžÑ‚ÐºÐ» (UZS/ÑˆÑ‚)" HorizontalTextAlignment="End"/>
                                                <Label FontSize="10" TextColor="Gray" Text="{Binding DeviationPct, StringFormat='{0:P1}'}" HorizontalTextAlignment="End"/>
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border Grid.Column="12" BackgroundColor="#D9F7BE" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð¡ÐµÐ±ÐµÑ/ÑˆÑ‚&#10;(UZS/ÑˆÑ‚)" LineBreakMode="WordWrap" HorizontalTextAlignment="End"/></Border>
                                        <Border Grid.Column="13" BackgroundColor="#E6E6E6" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð˜Ñ‚Ð¾Ð³Ð¾&#10;(UZS, Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ)" LineBreakMode="WordWrap" HorizontalTextAlignment="End"/></Border>
                                    </Grid>
                                    <CollectionView Grid.Row="2" ItemsSource="{Binding Rows}" SelectionMode="None" HeightRequest="260" ItemSizingStrategy="MeasureAllItems" WidthRequest="2200" HorizontalOptions="Start">
                                        <CollectionView.EmptyView>
                                            <Label Text="ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐŸÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ." TextColor="Gray" Padding="8"/>
                                        </CollectionView.EmptyView>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Grid ColumnSpacing="0" WidthRequest="2200" HorizontalOptions="Start">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="40"/>
                                                        <ColumnDefinition Width="240"/>
                                                        <ColumnDefinition Width="90"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="140"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Border Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding Index}"/></Border>
                                                    <Border Grid.Column="1" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellLabel}" Text="{Binding SkuOrName}"/></Border>
                                                    <Border Grid.Column="2" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding Quantity, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="3" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding BasePriceUzs, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="4" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding CustomsUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="5" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding LoadingUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="6" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding LogisticsUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="7" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding WarehouseUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="8" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding DeclarationUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="9" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding CertificationUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="10" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding McsUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="11" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding DeviationUzsPerUnit, StringFormat='{0:N2}'}"/></Border>
                                                    <Border Grid.Column="12" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding CostPerUnitUzs, StringFormat='{0:N2}'}"/></Border>
                                                    <!-- Per-position total cost in UZS -->
                                                    <Border Grid.Column="13" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding LineCostUzs, StringFormat='{0:N2}'}"/></Border>
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <!-- Totals row: sums by component (UZS) and averages where applicable -->
                                    <Grid Grid.Row="3" ColumnSpacing="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="240"/>
                                            <ColumnDefinition Width="90"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Î£"/></Border>
                                        <Border Grid.Column="1" Style="{StaticResource CellBorder}"><Label Style="{StaticResource TableHeaderLabel}" Text="Ð˜Ñ‚Ð¾Ð³Ð¸"/></Border>
                                        <Border Grid.Column="2" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalQty, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="3" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalBaseSumUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="4" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalCustomsUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="5" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalLoadingUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="6" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalLogisticsUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="7" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalWarehouseUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="8" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalDeclarationUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="9" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalCertificationUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="10" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalMcsUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="11" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalDeviationUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="12" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding WeightedCostPerUnitUzs, StringFormat='{0:N2}'}"/></Border>
                                        <Border Grid.Column="13" Style="{StaticResource CellBorder}"><Label Style="{StaticResource CellNum}" Text="{Binding TotalCostUzs, StringFormat='{0:N2}'}"/></Border>
                                    </Grid>
                                </Grid>
                            </Grid>
                        </ScrollView>

                        <Grid ColumnDefinitions="*,Auto,Auto" Margin="0,6,0,0">
                            <Label Grid.Column="0" Text="Ð˜Ñ‚Ð¾Ð³Ð¾" FontSize="14"/>
                            <Label Grid.Column="1" Text="{Binding TotalQty, StringFormat='ÐšÐ¾Ð»-Ð²Ð¾: {0:N2}'}" FontSize="14"/>
                            <Label Grid.Column="2" Text="{Binding TotalBaseSumUzs, StringFormat='Ð‘Ð°Ð·Ð°: {0:N2} UZS'}" FontSize="14"/>
                        </Grid>
                    </VerticalStackLayout>
                </ContentView.Content>
            </ContentView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>