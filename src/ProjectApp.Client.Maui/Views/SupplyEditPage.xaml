<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:services="clr-namespace:ProjectApp.Client.Maui.Services"
             x:Class="ProjectApp.Client.Maui.Views.SupplyEditPage"
             Title="Редактирование поставки"
             x:DataType="{x:Null}">
    <!-- ===== RESOURCES / STYLES ===== -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Табличные стили -->
            <Style x:Key="TableHeaderLabel"
                   TargetType="Label">
                <Setter Property="FontAttributes"
                        Value="Bold" />
                <Setter Property="FontSize"
                        Value="12" />
                <Setter Property="Padding"
                        Value="8,6" />
                <Setter Property="BackgroundColor"
                        Value="#ecf0f1" />
                <Setter Property="TextColor"
                        Value="#2c3e50" />
                <Setter Property="LineBreakMode"
                        Value="TailTruncation" />
            </Style>
            <Style x:Key="CellLabel"
                   TargetType="Label">
                <Setter Property="FontSize"
                        Value="12" />
                <Setter Property="Padding"
                        Value="8,6" />
                <Setter Property="LineBreakMode"
                        Value="TailTruncation" />
                <Setter Property="VerticalTextAlignment"
                        Value="Center" />
            </Style>
            <Style x:Key="CellMuted"
                   TargetType="Label"
                   BasedOn="{StaticResource CellLabel}">
                <Setter Property="FontSize"
                        Value="11" />
                <Setter Property="TextColor"
                        Value="Gray" />
            </Style>
            <Style x:Key="CellNum"
                   TargetType="Label"
                   BasedOn="{StaticResource CellLabel}">
                <Setter Property="HorizontalTextAlignment"
                        Value="End" />
            </Style>
            <Style x:Key="CellBorder"
                   TargetType="Border">
                <Setter Property="Stroke"
                        Value="#d1d5db" />
                <Setter Property="StrokeThickness"
                        Value="1" />
            </Style>
            <Style x:Key="FieldLabel"
                   TargetType="Label">
                <Setter Property="VerticalTextAlignment"
                        Value="Center" />
                <Setter Property="FontSize"
                        Value="13" />
            </Style>
            <Style x:Key="FieldEntry"
                   TargetType="Entry">
                <Setter Property="Keyboard"
                        Value="Numeric" />
                <Setter Property="FontSize"
                        Value="13" />
                <Setter Property="HeightRequest"
                        Value="36" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    <!-- ===== TOOLBAR ===== -->
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Добавить товар"
                     Clicked="OnAddProductClicked"
                     IconImageSource="add.png" />
        <ToolbarItem Text="🔄 Пересчитать"
                     Clicked="OnRecalculateClicked" />
    </ContentPage.ToolbarItems>
    <!-- ===== PAGE ===== -->
    <ScrollView>
        <VerticalStackLayout Padding="10"
                             Spacing="10">
            <!-- Заголовок поставки -->
            <Frame BorderColor="LightGray"
                   CornerRadius="8"
                   Padding="12"
                   Margin="0,0,0,4">
                <Grid RowDefinitions="Auto,Auto"
                      ColumnDefinitions="*,Auto"
                      ColumnSpacing="8">
                    <Label Grid.Row="0"
                           Grid.Column="0"
                           Text="{Binding Supply.Code, StringFormat='Поставка: {0}', FallbackValue='Поставка: …'}"
                           FontSize="20"
                           FontAttributes="Bold" />
                    <Label Grid.Row="1"
                           Grid.Column="0"
                           Text="{Binding Supply.RegisterType, StringFormat='Регистр: {0}', FallbackValue='Регистр: …'}"
                           FontSize="13"
                           TextColor="Gray" />
                </Grid>
            </Frame>
            <!-- Список товаров -->
            <Label Text="Товары в поставке:"
                   FontSize="16"
                   FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding SupplyItems}"
                            SelectionMode="None"
                            HeightRequest="240">
                <CollectionView.EmptyView>
                    <Label Text="Нет товаров. Нажмите '+' чтобы добавить."
                           TextColor="Gray"
                           HorizontalTextAlignment="Center"
                           Margin="0,12,0,0" />
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="services:SupplyItemDto">
                        <Frame Margin="0,6"
                               Padding="10"
                               BorderColor="LightGray">
                            <Grid RowDefinitions="Auto,Auto,Auto"
                                  ColumnDefinitions="*,Auto"
                                  ColumnSpacing="8">
                                <Label Grid.Row="0"
                                       Grid.Column="0"
                                       Text="{Binding Name}"
                                       FontSize="15"
                                       FontAttributes="Bold" />
                                <Button Grid.Row="0"
                                        Grid.Column="1"
                                        Text="🗑️"
                                        Clicked="OnRemoveProductClicked"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#e74c3c"
                                        TextColor="White"
                                        WidthRequest="36"
                                        HeightRequest="36" />
                                <Label Grid.Row="1"
                                       Grid.Column="0"
                                       Grid.ColumnSpan="2"
                                       Text="{Binding Sku, StringFormat='SKU: {0}'}"
                                       FontSize="12"
                                       TextColor="Gray" />
                                <Grid Grid.Row="2"
                                      Grid.Column="0"
                                      Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,*,*"
                                      ColumnSpacing="8"
                                      Margin="0,4,0,0">
                                    <Label Grid.Column="0"
                                           Text="{Binding Quantity, StringFormat='Кол-во: {0}'}"
                                           FontSize="12" />
                                    <Label Grid.Column="1"
                                           Text="{Binding PriceRub, StringFormat='Цена: {0:F2} ₽'}"
                                           FontSize="12" />
                                    <Label Grid.Column="2"
                                           Text="{Binding Weight, StringFormat='Вес: {0:F2} кг'}"
                                           FontSize="12" />
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <!-- Секция расчёта -->
            <Frame BackgroundColor="#3498db"
                   Padding="12"
                   CornerRadius="8">
                <Label Text="💰 РАСЧЁТ СЕБЕСТОИМОСТИ"
                       TextColor="White"
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center" />
            </Frame>
            <Frame BorderColor="#3498db"
                   Padding="12"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="10">
                    <!-- Параметры (понятные подписи + плейсхолдеры) -->
                    <Grid ColumnDefinitions="*,*,*,*,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">

                      <Grid Grid.Row="0" Grid.Column="0" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Курс ₽→UZS:" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding ExchangeRate, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="например: 158,08"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="0" Grid.Column="1" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="НДС (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding VatPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.22 = 22%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="0" Grid.Column="2" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Логистика (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding LogisticsPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.05 = 5%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="0" Grid.Column="3" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Склад (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding WarehousePct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.005 = 0.5%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="0" Grid.Column="4" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Декларация (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding DeclarationPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.002 = 0.2%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="1" Grid.Column="0" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Сертификация (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding CertificationPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.01 = 1%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="1" Grid.Column="1" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="МЧС (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding MchsPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.01 = 1%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="1" Grid.Column="2" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Отклонения (%):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding DeviationPct, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="0.015 = 1.5%"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="1" Grid.Column="3" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Таможня (UZS):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding CustomsTotalAbs, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="например: 1 030 000"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                      <Grid Grid.Row="1" Grid.Column="4" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <Label Grid.Column="0" Text="Погрузка (UZS):" VerticalTextAlignment="Center" FontSize="12" TextColor="Gray"/>
                        <Entry Grid.Column="1"
                               Text="{Binding LoadingTotalAbs, Mode=TwoWay}"
                               Keyboard="Numeric"
                               Placeholder="например: 1 000 000"
                               TextChanged="OnInlineNumberChanged"/>
                      </Grid>

                    </Grid>
                    <BoxView HeightRequest="1"
                             Color="#e5e7eb"
                             Margin="0,2,0,0" />
                    <!-- Инфо и итог -->
                    <Grid ColumnDefinitions="*,Auto"
                          Margin="0,-2,0,0">
                        <Label Grid.Column="0"
                               Text="Товаров в расчёте:"
                               FontSize="14" />
                        <Label Grid.Column="1"
                               Text="{Binding CostItemsCount}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="#2980b9" />
                    </Grid>
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="ИТОГО СЕБЕСТОИМОСТЬ:"
                               FontSize="18"
                               FontAttributes="Bold" />
                        <Label Grid.Column="1"
                               Text="{Binding TotalCost, StringFormat='{0:N0} UZS'}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#e74c3c" />
                    </Grid>
                    <Label Text="Детализация расчёта:"
                           FontAttributes="Bold"
                           FontSize="16" />
                    <!-- ===== Таблица (резиновая ширина) ===== -->
                    <ScrollView Orientation="Both"
                                HeightRequest="260"
                                HorizontalScrollBarVisibility="Always"
                                VerticalScrollBarVisibility="Always">
                        <Grid>
                            <Grid x:Name="CostTableHost"
                                  WidthRequest="{OnIdiom Phone=1100, Tablet=1400, Desktop=1600}"
                                  RowDefinitions="Auto,*">
                                <!-- Шапка -->
                                <Grid Grid.Row="0"
                                      ColumnDefinitions="40,300,120,90,140,140,140,140,140,140,140,140,180"
                                      ColumnSpacing="0"
                                      RowSpacing="0">
                                    <Border Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="#" />
                                    </Border>
                                    <Border Grid.Column="1"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="наименование" />
                                    </Border>
                                    <Border Grid.Column="2"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="цена ₽"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="3"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="курс"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="4"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="цена в сумах"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="5"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="таможня"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="6"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="ндс"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="7"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="логистика"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="8"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="склад"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="9"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="декларация"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="10"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="сертификация"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="11"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="прочие / погрузка"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                    <Border Grid.Column="12"
                                            Style="{StaticResource CellBorder}">
                                        <Label Style="{StaticResource TableHeaderLabel}"
                                               Text="себес / итого"
                                               HorizontalTextAlignment="End" />
                                    </Border>
                                </Grid>
                                <!-- Строки -->
                                <CollectionView Grid.Row="1"
                                                ItemsSource="{Binding CostItems}"
                                                SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="{x:Null}">
                                            <Grid ColumnDefinitions="40,300,120,90,140,140,140,140,140,140,140,140,180"
                                                  ColumnSpacing="0"
                                                  RowSpacing="0">
                                                <!-- # -->
                                                <Border Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}"
                                                           Text="{Binding RowNumber}" />
                                                </Border>
                                                <!-- Товар + кол-во -->
                                                <Border Grid.Column="1"
                                                        Style="{StaticResource CellBorder}">
                                                    <VerticalStackLayout Spacing="2"
                                                                         Padding="8,6">
                                                        <Label Text="{Binding ProductName}"
                                                               FontAttributes="Bold"
                                                               FontSize="13" />
                                                        <Label Style="{StaticResource CellMuted}"
                                                               Text="{Binding Quantity, StringFormat='количество: {0}'}" />
                                                    </VerticalStackLayout>
                                                </Border>
                                                <!-- Цена ₽ -->
                                                <Border Grid.Column="2"
                                                        Style="{StaticResource CellBorder}">
                                                    <Entry Text="{Binding PriceRub, Mode=TwoWay, StringFormat='{}{0:F2}'}"
                                                       x:Name="PriceRubEntry"
                                                       TextChanged="OnPriceRubChanged"
                                                       Keyboard="Numeric"
                                                       HorizontalTextAlignment="End"
                                                       FontSize="12"
                                                       WidthRequest="120" />
                                                </Border>
                                                <!-- Курс -->
                                                <Border Grid.Column="3"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}"
                                                           Text="{Binding ExchangeRate, StringFormat='{0:F2}'}" />
                                                </Border>
                                                <!-- Цена UZS -->
                                                <Border Grid.Column="4"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}"
                                                           Text="{Binding PriceUzs, StringFormat='{0:N0}'}" />
                                                </Border>
                                                <!-- Таможня -->
                                                <Border Grid.Column="5"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}"
                                                           Text="{Binding CustomsUzs, StringFormat='{0:N0}'}" />
                                                </Border>
                                                <!-- НДС -->
                                                <Border Grid.Column="6"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}"
                                                           Text="{Binding VatUzs, StringFormat='{0:N0}'}" />
                                                </Border>
                                                <!-- Логистика -->
                                                <Border Grid.Column="7"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="{Binding LogisticsUzs, StringFormat='{}{0:N0}'}" />
                                                                <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.LogisticsPct, StringFormat=' ({0:P1})'}"
                                                                      FontSize="11"
                                                                      TextColor="Gray" />
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </Border>
                                                <!-- Склад -->
                                                <Border Grid.Column="8"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="{Binding StorageUzs, StringFormat='{}{0:N0}'}" />
                                                                <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.WarehousePct, StringFormat=' ({0:P1})'}"
                                                                      FontSize="11"
                                                                      TextColor="Gray" />
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </Border>
                                                <!-- Декларация -->
                                                <Border Grid.Column="9"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="{Binding DeclarationUzs, StringFormat='{}{0:N0}'}" />
                                                                <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeclarationPct, StringFormat=' ({0:P1})'}"
                                                                      FontSize="11"
                                                                      TextColor="Gray" />
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </Border>
                                                <!-- Сертификация -->
                                                <Border Grid.Column="10"
                                                        Style="{StaticResource CellBorder}">
                                                    <Label Style="{StaticResource CellNum}">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="{Binding CertificationUzs, StringFormat='{}{0:N0}'}" />
                                                                <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CertificationPct, StringFormat=' ({0:P1})'}"
                                                                      FontSize="11"
                                                                      TextColor="Gray" />
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </Border>
                                                <!-- Прочие / Погрузка + МЧС + Отклонения -->
                                                <Border Grid.Column="11"
                                                        Style="{StaticResource CellBorder}">
                                                    <VerticalStackLayout Spacing="2"
                                                                         Padding="8,6">
                                                        <Label HorizontalTextAlignment="End">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="МЧС: " />
                                                                    <Span Text="{Binding MChsUzs, StringFormat='{}{0:N0}'}" />
                                                                    <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.MchsPct, StringFormat=' ({0:P1})'}"
                                                                          FontSize="11"
                                                                          TextColor="Gray" />
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>
                                                        <Label HorizontalTextAlignment="End">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="Откл: " />
                                                                    <Span Text="{Binding UnforeseenUzs, StringFormat='{}{0:N0}'}" />
                                                                    <Span Text="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeviationPct, StringFormat=' ({0:P1})'}"
                                                                          FontSize="11"
                                                                          TextColor="Gray" />
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>
                                                        <Label HorizontalTextAlignment="End">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="Погрузка: " />
                                                                    <Span Text="{Binding LoadingUzs, StringFormat='{}{0:N0}'}" />
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>
                                                    </VerticalStackLayout>
                                                </Border>
                                                <!-- Себес / итого -->
                                                <Border Grid.Column="12"
                                                        Style="{StaticResource CellBorder}">
                                                    <VerticalStackLayout Spacing="2"
                                                                         Padding="8,6">
                                                        <Label Style="{StaticResource CellNum}"
                                                               FontAttributes="Bold"
                                                               Text="{Binding UnitCostUzs, StringFormat='{0:N0} UZS'}" />
                                                        <Label HorizontalTextAlignment="End"
                                                               Style="{StaticResource CellMuted}">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="× " />
                                                                    <Span Text="{Binding Quantity}" />
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>
                                                        <Label HorizontalTextAlignment="End"
                                                               FontAttributes="Bold"
                                                               TextColor="#27ae60">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="= " />
                                                                    <Span Text="{Binding TotalCostUzs, StringFormat='{}{0:N0} UZS'}" />
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>
                                                    </VerticalStackLayout>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Grid>
                    </ScrollView>
                    <BoxView HeightRequest="1"
                             Color="#e5e7eb"
                             Margin="0,4,0,0" />
                    <Label Text="Формулы: Цена UZS = Цена ₽ × Курс. Процентные статьи считаются от цены в UZS. Таможня и погрузка — фикс. суммы, распределяются пропорционально количеству."
                           FontSize="12"
                           TextColor="Gray" />
                </VerticalStackLayout>
            </Frame>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>