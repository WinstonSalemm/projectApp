<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             x:Class="ProjectApp.Client.Maui.Views.DefectivesPage"
             x:DataType="vm:DefectivesViewModel"
             Title="ðŸ—‘ï¸ Ð‘Ñ€Ð°Ðº"
             BackgroundColor="{DynamicResource Color.Background}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Command="{Binding LoadDefectivesCommand}" />
    </ContentPage.ToolbarItems>

    <ScrollView VerticalScrollBarVisibility="Always">
        <VerticalStackLayout Padding="16" Spacing="20">

            <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                             IsVisible="{Binding IsLoading}"
                             HeightRequest="50" />

            <!-- Ð¤ÐžÐ ÐœÐ Ð¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð¯ Ð‘Ð ÐÐšÐ -->
            <Frame Style="{StaticResource Card}" Padding="20">
                <VerticalStackLayout Spacing="16">
                    <Label Text="ðŸ—‘ï¸ Ð¡Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð±Ñ€Ð°Ðº"
                           FontSize="18"
                           TextColor="{DynamicResource Color.Text.Primary}"
                           FontFamily="InterBold" />

                    <!-- Ð¢Ð¾Ð²Ð°Ñ€ -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="ID Ð¢Ð¾Ð²Ð°Ñ€Ð°:"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Entry Text="{Binding ProductIdText}"
                               Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‚Ð¾Ð²Ð°Ñ€Ð°"
                               Keyboard="Numeric"
                               FontSize="16" />
                        <Label Text="{Binding SelectedProductName}"
                               FontSize="12"
                               TextColor="{DynamicResource Color.Primary}"
                               IsVisible="{Binding SelectedProductName, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                               Margin="4,4,0,0" />
                    </VerticalStackLayout>

                    <!-- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾:"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Entry Text="{Binding Quantity}"
                               Placeholder="1"
                               Keyboard="Numeric"
                               FontSize="16" />
                    </VerticalStackLayout>

                    <!-- Ð¡ÐºÐ»Ð°Ð´ -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Ð¡ÐºÐ»Ð°Ð´:"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Button Text="{Binding WarehouseName}"
                                Command="{Binding ToggleWarehouseCommand}"
                                Style="{StaticResource Button.Secondary}" />
                    </VerticalStackLayout>

                    <!-- ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð±Ñ€Ð°ÐºÐ° -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð±Ñ€Ð°ÐºÐ°:"
                               FontSize="13"
                               TextColor="{DynamicResource Color.Text.Secondary}" />
                        <Editor Text="{Binding Reason}"
                                Placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÐŸÐ¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð¿ÑƒÑÐ° Ð¿Ñ€Ð¸ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐµ"
                                HeightRequest="80"
                                FontSize="14" />
                    </VerticalStackLayout>

                    <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° -->
                    <Button Text="ðŸ—‘ï¸ Ð¡Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð±Ñ€Ð°Ðº"
                            Command="{Binding CreateDefectiveCommand}"
                            IsEnabled="{Binding CanSubmit}"
                            Style="{StaticResource Button.Danger}" />

                    <Label Text="âš ï¸ Ð¢Ð¾Ð²Ð°Ñ€ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¿Ð¸ÑÐ°Ð½ ÑÐ¾ ÑÐºÐ»Ð°Ð´Ð°"
                           FontSize="11"
                           TextColor="{DynamicResource Color.Text.Secondary}"
                           HorizontalOptions="Center"
                           FontAttributes="Italic" />
                </VerticalStackLayout>
            </Frame>

            <!-- Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð‘Ð ÐÐšÐ -->
            <Label Text="ðŸ“œ Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð‘Ð ÐÐšÐ"
                   FontSize="16"
                   TextColor="{DynamicResource Color.Text.Primary}"
                   FontFamily="InterBold"
                   Margin="0,12,0,0" />

            <CollectionView ItemsSource="{Binding Defectives}"
                          EmptyView="ÐÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¾ Ð±Ñ€Ð°ÐºÐµ">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:DefectiveRow">
                        <Frame Margin="0,0,0,12"
                               Padding="16"
                               Style="{StaticResource CardFrame}">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" 
                                  ColumnDefinitions="100,*"
                                  RowSpacing="8">
                                
                                <!-- Ð¢Ð¾Ð²Ð°Ñ€ -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="ðŸ“¦ Ð¢Ð¾Ð²Ð°Ñ€:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding ProductName}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Primary}"
                                       FontFamily="InterSemiBold" />

                                <!-- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="ðŸ“Š ÐšÐ¾Ð»-Ð²Ð¾:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Quantity, StringFormat='{0} ÑˆÑ‚.'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Error}"
                                       FontFamily="InterSemiBold" />

                                <!-- Ð¡ÐºÐ»Ð°Ð´ -->
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="ðŸ¢ Ð¡ÐºÐ»Ð°Ð´:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="2" Grid.Column="1"
                                       Text="{Binding Warehouse}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Primary}" />

                                <!-- ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° -->
                                <Label Grid.Row="3" Grid.Column="0"
                                       Text="ðŸ“ ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="3" Grid.Column="1"
                                       Text="{Binding Reason}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Primary}"
                                       LineBreakMode="WordWrap" />

                                <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ -->
                                <Label Grid.Row="4" Grid.Column="0"
                                       Text="âš¡ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:"
                                       FontSize="12"
                                       TextColor="{DynamicResource Color.Text.Secondary}" />
                                <Label Grid.Row="4" Grid.Column="1"
                                       Text="{Binding Status}"
                                       FontSize="12"
                                       TextColor="{Binding StatusColor}"
                                       FontFamily="InterSemiBold" />

                                <!-- Ð”Ð°Ñ‚Ð° -->
                                <Label Grid.Row="5" Grid.Column="0"
                                       Text="ðŸ“… Ð”Ð°Ñ‚Ð°:"
                                       FontSize="11"
                                       TextColor="{DynamicResource Color.Text.Tertiary}" />
                                <Label Grid.Row="5" Grid.Column="1"
                                       Text="{Binding CreatedAt, StringFormat='{0} / {1}'}"
                                       FontSize="11"
                                       TextColor="{DynamicResource Color.Text.Tertiary}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding CreatedAt}" />
                                            <Span Text=" / " />
                                            <Span Text="{Binding CreatedBy}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ -->
                                <Button Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="2"
                                        Text="â†©ï¸ ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ (Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð½Ð° ÑÐºÐ»Ð°Ð´)"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DefectivesViewModel}}, Path=CancelDefectiveCommand}"
                                        CommandParameter="{Binding .}"
                                        IsVisible="{Binding CanCancel}"
                                        Style="{StaticResource Button.Secondary}"
                                        Margin="0,8,0,0" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ÐŸÑƒÑÑ‚Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð²Ð½Ð¸Ð·Ñƒ -->
            <BoxView HeightRequest="20" Color="Transparent" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
