<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:models="clr-namespace:ProjectApp.Client.Maui.Models"
             xmlns:controls="clr-namespace:ProjectApp.Client.Maui.Controls"
             x:Class="ProjectApp.Client.Maui.Views.ClientsListPage"
             x:Name="Page"
             Title="Клиенты">
  <ContentPage.Resources>
    <ResourceDictionary>
      <GridItemsLayout x:Key="ItemsLayout.Compact"
                       Orientation="Vertical"
                       Span="1"
                       HorizontalItemSpacing="{StaticResource Space.3}"
                       VerticalItemSpacing="{StaticResource Space.3}" />
      <GridItemsLayout x:Key="ItemsLayout.Medium"
                       Orientation="Vertical"
                       Span="2"
                       HorizontalItemSpacing="{StaticResource Space.3}"
                       VerticalItemSpacing="{StaticResource Space.3}" />
      <GridItemsLayout x:Key="ItemsLayout.Expanded"
                       Orientation="Vertical"
                       Span="3"
                       HorizontalItemSpacing="{StaticResource Space.4}"
                       VerticalItemSpacing="{StaticResource Space.4}" />
    </ResourceDictionary>
  </ContentPage.Resources>

  <VisualStateManager.VisualStateGroups>
    <VisualStateGroup x:Name="AdaptiveStates">
      <VisualState Name="Compact">
        <VisualState.Setters>
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Compact}" />
        </VisualState.Setters>
      </VisualState>
      <VisualState Name="Medium">
        <VisualState.Setters>
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Medium}" />
        </VisualState.Setters>
      </VisualState>
      <VisualState Name="Expanded">
        <VisualState.Setters>
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Expanded}" />
        </VisualState.Setters>
      </VisualState>
    </VisualStateGroup>
  </VisualStateManager.VisualStateGroups>

  <Grid x:Name="Root"
        RowDefinitions="Auto,Auto,*"
        RowSpacing="20"
        Padding="20">

    <!-- Верхняя панель -->
    <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
      <!-- Поиск -->
      <SearchBar Grid.Column="0"
                 Placeholder="Поиск по имени или телефону"
                 Text="{Binding Query}"
                 HeightRequest="50"
                 FontSize="16"
                 VerticalOptions="Center"/>
      
      <!-- Кнопка Обновить -->
      <Button Grid.Column="1"
              Text="Обновить"
              Style="{StaticResource Button.Secondary}"
              Command="{Binding LoadCommand}"
              HeightRequest="50"
              MinimumWidthRequest="120"
              FontSize="16"/>
      
      <!-- Кнопка Добавить -->
      <Button Grid.Column="2"
              Text="Добавить клиента"
              Style="{StaticResource Button.Primary}"
              Command="{Binding OpenCreateCommand}"
              HeightRequest="50"
              MinimumWidthRequest="180"
              FontSize="16"/>
    </Grid>

    <!-- Фильтры -->
    <Border Grid.Row="1"
            StrokeThickness="1"
            Stroke="{DynamicResource Color.Border}"
            BackgroundColor="{DynamicResource Color.Surface}"
            StrokeShape="RoundRectangle 8"
            Padding="16">
      <Grid ColumnDefinitions="Auto,200,Auto,200,Auto,Auto" ColumnSpacing="16" RowSpacing="0">
        <!-- Тип -->
        <Label Grid.Column="0" 
               Text="Тип:"
               FontSize="15"
               FontAttributes="Bold"
               VerticalTextAlignment="Center"/>
        <Picker Grid.Column="1"
                Title="Выберите тип"
                SelectedItem="{Binding SelectedType}"
                HeightRequest="40"
                FontSize="15"
                VerticalOptions="Center">
          <Picker.ItemsSource>
            <x:Array Type="{x:Type models:ClientType}">
              <x:Static Member="models:ClientType.Individual" />
              <x:Static Member="models:ClientType.Company" />
            </x:Array>
          </Picker.ItemsSource>
        </Picker>

        <!-- Менеджер -->
        <Label Grid.Column="2" 
               Text="Менеджер:"
               FontSize="15"
               FontAttributes="Bold"
               VerticalTextAlignment="Center"/>
        <Picker Grid.Column="3"
                Title="Все менеджеры"
                SelectedItem="{Binding SelectedManager}"
                ItemsSource="{Binding Managers}"
                ItemDisplayBinding="{Binding .}"
                HeightRequest="40"
                FontSize="15"
                VerticalOptions="Center"/>

        <!-- Только мои -->
        <HorizontalStackLayout Grid.Column="4" Spacing="8" VerticalOptions="Center">
          <Label Text="Только мои"
                 FontSize="15"
                 VerticalTextAlignment="Center"/>
          <Switch IsToggled="{Binding ShowOnlyMine}"/>
        </HorizontalStackLayout>

        <!-- Незарегистрированные -->
        <Button Grid.Column="5"
                Text="Незарегистрированные"
                Style="{StaticResource Button.Tertiary}"
                Command="{Binding OpenUnregisteredCommand}"
                HeightRequest="40"
                FontSize="15"
                Padding="16,0"/>
      </Grid>
    </Border>

    <CollectionView x:Name="ClientsCollection"
                    Grid.Row="2"
                    Margin="0,0,0,24"
                    ItemsSource="{Binding Items}"
                    SelectionMode="None">
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Border StrokeThickness="1"
                  Stroke="{DynamicResource Color.Border}"
                  BackgroundColor="{DynamicResource Color.Surface}"
                  StrokeShape="RoundRectangle 8"
                  Padding="16"
                  Margin="0,0,0,12">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Command="{Binding Source={x:Reference Page}, Path=BindingContext.OpenDetailCommand}" CommandParameter="{Binding .}" />
            </Border.GestureRecognizers>
            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
              <!-- Имя и тип -->
              <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                <Label Grid.Column="0" 
                       Text="{Binding Name}" 
                       FontSize="18" 
                       FontAttributes="Bold" 
                       LineBreakMode="TailTruncation"/>
                <Label Grid.Column="1" 
                       Text="{Binding Type, Converter={StaticResource ClientTypeToRuConverter}}" 
                       FontSize="13"
                       TextColor="{DynamicResource Color.Text.Secondary}"/>
              </Grid>
              
              <!-- Телефон и Оборот -->
              <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="16">
                <Label Grid.Column="0"
                       Text="{Binding Phone}" 
                       FontSize="15" 
                       TextColor="{DynamicResource Color.Text.Secondary}"/>
                <Label Grid.Column="1"
                       Text="{Binding TotalRevenue, StringFormat='Оборот: {0:N0} сум'}" 
                       FontSize="15" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Color.Primary}"/>
              </Grid>
              
              <!-- Менеджер (если есть) -->
              <Label Grid.Row="2" 
                     Text="{Binding OwnerUserName, StringFormat='Менеджер: {0}'}" 
                     FontSize="13" 
                     TextColor="{DynamicResource Color.Text.Secondary}"
                     IsVisible="{Binding HasOwner}"/>
            </Grid>
          </Border>
        </DataTemplate>
      </CollectionView.ItemTemplate>
      <CollectionView.EmptyView>
        <controls:EmptyStateView Title="Клиентов пока нет"
                                 Description="Создайте карточку клиента для добавления в список"
                                 ActionText="Создать клиента"
                                 ActionCommand="{Binding Source={x:Reference Page}, Path=BindingContext.OpenCreateCommand}" />
      </CollectionView.EmptyView>
    </CollectionView>
  </Grid>
</ContentPage>




