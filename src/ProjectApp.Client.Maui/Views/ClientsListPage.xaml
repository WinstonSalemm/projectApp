<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:ProjectApp.Client.Maui.ViewModels"
             xmlns:models="clr-namespace:ProjectApp.Client.Maui.Models"
             xmlns:controls="clr-namespace:ProjectApp.Client.Maui.Controls"
             x:Class="ProjectApp.Client.Maui.Views.ClientsListPage"
             x:Name="Page"
             Title="Клиенты">
  <ContentPage.Resources>
    <ResourceDictionary>
      <GridItemsLayout x:Key="ItemsLayout.Compact"
                       Orientation="Vertical"
                       Span="1"
                       HorizontalItemSpacing="{StaticResource Space.3}"
                       VerticalItemSpacing="{StaticResource Space.3}" />
      <GridItemsLayout x:Key="ItemsLayout.Medium"
                       Orientation="Vertical"
                       Span="2"
                       HorizontalItemSpacing="{StaticResource Space.3}"
                       VerticalItemSpacing="{StaticResource Space.3}" />
      <GridItemsLayout x:Key="ItemsLayout.Expanded"
                       Orientation="Vertical"
                       Span="3"
                       HorizontalItemSpacing="{StaticResource Space.4}"
                       VerticalItemSpacing="{StaticResource Space.4}" />
    </ResourceDictionary>
  </ContentPage.Resources>

  <VisualStateManager.VisualStateGroups>
    <VisualStateGroup x:Name="AdaptiveStates">
      <VisualState Name="Compact">
        <VisualState.Setters>
          <Setter TargetName="ActionBar" Property="FlexLayout.Direction" Value="Column" />
          <Setter TargetName="ActionBar" Property="FlexLayout.AlignItems" Value="Stretch" />
          <Setter TargetName="FiltersLayout" Property="FlexLayout.Direction" Value="Column" />
          <Setter TargetName="FiltersLayout" Property="FlexLayout.AlignItems" Value="Stretch" />
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Compact}" />
        </VisualState.Setters>
      </VisualState>
      <VisualState Name="Medium">
        <VisualState.Setters>
          <Setter TargetName="ActionBar" Property="FlexLayout.Direction" Value="Row" />
          <Setter TargetName="ActionBar" Property="FlexLayout.AlignItems" Value="Center" />
          <Setter TargetName="FiltersLayout" Property="FlexLayout.Direction" Value="Row" />
          <Setter TargetName="FiltersLayout" Property="FlexLayout.AlignItems" Value="Center" />
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Medium}" />
        </VisualState.Setters>
      </VisualState>
      <VisualState Name="Expanded">
        <VisualState.Setters>
          <Setter TargetName="ActionBar" Property="FlexLayout.Direction" Value="Row" />
          <Setter TargetName="FiltersLayout" Property="FlexLayout.Direction" Value="Row" />
          <Setter TargetName="ClientsCollection" Property="CollectionView.ItemsLayout" Value="{StaticResource ItemsLayout.Expanded}" />
        </VisualState.Setters>
      </VisualState>
    </VisualStateGroup>
  </VisualStateManager.VisualStateGroups>

  <Grid x:Name="Root"
        RowDefinitions="Auto,Auto,*"
        RowSpacing="{StaticResource Space.4}">

    <FlexLayout x:Name="ActionBar"
                Grid.Row="0"
                Direction="Row"
                Wrap="Wrap"
                AlignItems="Center"
                JustifyContent="SpaceBetween">
      <SearchBar Placeholder="Поиск по имени или телефону"
                 Text="{Binding Query}"
                 FlexLayout.Grow="1"
                 SemanticProperties.Description="Поиск клиентов по имени, телефону или компании" />
      <Button Text="Обновить"
              Style="{StaticResource Button.Secondary}"
              Command="{Binding LoadCommand}"
              Margin="0,0,0,8"
              ContentLayout="Left,8"
              ImageSource="{StaticResource IconRefresh}" />
      <Button Text="Добавить клиента"
              Style="{StaticResource Button.Primary}"
              Command="{Binding OpenCreateCommand}"
              Margin="0,0,0,8"
              ContentLayout="Left,8"
              ImageSource="{StaticResource IconAdd}"
              SemanticProperties.Description="Создать нового клиента" />
    </FlexLayout>

    <Border Grid.Row="1"
            Style="{StaticResource Card.Container}">
      <FlexLayout x:Name="FiltersLayout"
                  Direction="Row"
                  Wrap="Wrap"
                  AlignItems="Center">
        <Label Text="Тип"
               FontAttributes="Bold"
               SemanticProperties.Description="Фильтр по типу клиента" />
        <Picker Title="Выберите тип"
                SelectedItem="{Binding SelectedType}"
                WidthRequest="200">
          <Picker.ItemsSource>
            <x:Array Type="{x:Type models:ClientType}">
              <x:Static Member="models:ClientType.Individual" />
              <x:Static Member="models:ClientType.Company" />
            </x:Array>
          </Picker.ItemsSource>
        </Picker>

        <Label Text="Менеджер"
               FontAttributes="Bold"
               Margin="16,0,8,0"
               SemanticProperties.Description="Фильтр по менеджеру" />
        <Picker Title="Все менеджеры"
                SelectedItem="{Binding SelectedManager}"
                ItemsSource="{Binding Managers}"
                ItemDisplayBinding="{Binding .}"
                WidthRequest="200" />

        <Border Style="{StaticResource Chip.Standard}">
          <HorizontalStackLayout Spacing="{StaticResource Space.2}" VerticalOptions="Center">
            <Label Text="Только мои"
                   VerticalTextAlignment="Center" />
            <Switch IsToggled="{Binding ShowOnlyMine}"
                    SemanticProperties.Description="Показать только моих клиентов" />
          </HorizontalStackLayout>
        </Border>

        <Button Text="Незарегистрированные"
                Style="{StaticResource Button.Tertiary}"
                Command="{Binding OpenUnregisteredCommand}"
                Margin="0,0,0,8" />
      </FlexLayout>
    </Border>

    <CollectionView x:Name="ClientsCollection"
                    Grid.Row="2"
                    Margin="0,0,0,24"
                    ItemsSource="{Binding Items}"
                    SelectionMode="None">
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Border Style="{StaticResource Card.Container}" Padding="12" Margin="0,0,0,8">
            <Border.GestureRecognizers>
              <TapGestureRecognizer Command="{Binding Source={x:Reference Page}, Path=BindingContext.OpenDetailCommand}" CommandParameter="{Binding .}" />
            </Border.GestureRecognizers>
            <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
              <!-- Имя и тип -->
              <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                <Label Grid.Column="0" Text="{Binding Name}" FontSize="16" FontAttributes="Bold" LineBreakMode="TailTruncation"/>
                <Border Grid.Column="1" Style="{StaticResource Chip.Standard}">
                  <Label Text="{Binding Type, Converter={StaticResource ClientTypeToRuConverter}}" FontSize="11"/>
                </Border>
              </Grid>
              
              <!-- Телефон -->
              <Label Grid.Row="1" Text="{Binding Phone}" FontSize="13" TextColor="{DynamicResource Color.Text.Secondary}"/>
              
              <!-- Оборот -->
              <Grid Grid.Row="2" ColumnDefinitions="Auto,*" ColumnSpacing="8" Margin="0,4,0,0">
                <Label Grid.Column="0" Text="💰" FontSize="14"/>
                <Label Grid.Column="1" Text="{Binding TotalRevenue, StringFormat='Оборот: {0:N0} сум'}" FontSize="13" FontAttributes="Bold" TextColor="{DynamicResource Color.Primary}"/>
              </Grid>
              
              <!-- Менеджер (если есть) -->
              <Label Grid.Row="3" Text="{Binding OwnerUserName, StringFormat='Менеджер: {0}'}" FontSize="11" TextColor="{DynamicResource Color.Text.Secondary}" IsVisible="{Binding HasOwner}"/>
            </Grid>
          </Border>
        </DataTemplate>
      </CollectionView.ItemTemplate>
      <CollectionView.EmptyView>
        <controls:EmptyStateView Title="Клиентов пока нет"
                                 Description="Создайте карточку клиента для добавления в список"
                                 ActionText="Создать клиента"
                                 ActionCommand="{Binding Source={x:Reference Page}, Path=BindingContext.OpenCreateCommand}" />
      </CollectionView.EmptyView>
    </CollectionView>
  </Grid>
</ContentPage>




