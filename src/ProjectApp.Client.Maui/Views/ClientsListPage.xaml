<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:ProjectApp.Client.Maui.Models"
             x:Class="ProjectApp.Client.Maui.Views.ClientsListPage"
             x:Name="Page"
             Title="Клиенты">
  <Grid Padding="16" RowDefinitions="Auto,Auto, *" RowSpacing="12">
    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="8">
      <Entry Grid.Column="0" Placeholder="Поиск по имени/телефону" Text="{Binding Query}"/>
      <Button Grid.Column="1" Text="Найти" Command="{Binding LoadCommand}" Style="{StaticResource OutlinedButton}" ImageSource="{StaticResource IconRefresh}" ContentLayout="Left,8"/>
    </Grid>

    <Grid Grid.Row="1" ColumnDefinitions="*,*,Auto,Auto" ColumnSpacing="8">
      <HorizontalStackLayout Grid.Column="0" Spacing="8">
        <Label Text="Тип:" VerticalTextAlignment="Center"/>
        <Picker Title="Все" SelectedItem="{Binding SelectedType}">
          <Picker.ItemsSource>
            <x:Array Type="{x:Type models:ClientType}">
              <x:Static Member="models:ClientType.Individual" />
              <x:Static Member="models:ClientType.Company" />
            </x:Array>
          </Picker.ItemsSource>
        </Picker>
      </HorizontalStackLayout>
      <HorizontalStackLayout Grid.Column="1" Spacing="8">
        <Label Text="Только мои" VerticalTextAlignment="Center"/>
        <Switch IsToggled="{Binding ShowOnlyMine}"/>
      </HorizontalStackLayout>
      <Button Grid.Column="2" Text="Добавить" Command="{Binding OpenCreateCommand}" Style="{StaticResource OutlinedButton}" ImageSource="{StaticResource IconAdd}" ContentLayout="Left,8"/>
      <Button Grid.Column="3" Text="Незаписанные" Command="{Binding OpenUnregisteredCommand}" Style="{StaticResource OutlinedButton}"/>
    </Grid>

    <CollectionView Grid.Row="2" ItemsSource="{Binding Items}">
      <CollectionView.ItemTemplate>
        <DataTemplate>
          <Frame Style="{StaticResource CardFrame}">
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
              <Label Grid.Row="0" Grid.ColumnSpan="2" Text="{Binding Name}" FontAttributes="Bold"/>
              <Label Grid.Row="1" Grid.Column="0" Text="{Binding Phone}"/>
              <!-- Client type badge -->
              <Frame Grid.Row="1" Grid.Column="1" Style="{StaticResource BadgeFrame}">
                <Label Text="{Binding Type, Converter={StaticResource ClientTypeToRuConverter}}" FontSize="12"/>
              </Frame>
              <Label Grid.Row="2" Grid.ColumnSpan="2" Text="{Binding OwnerUserName, StringFormat='Владелец: {0}'}" FontSize="12" TextColor="Gray"/>
              <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding Source={x:Reference Page}, Path=BindingContext.OpenDetailCommand}"
                                       CommandParameter="{Binding .}"/>
              </Grid.GestureRecognizers>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
      <CollectionView.EmptyView>
        <VerticalStackLayout Padding="12" Spacing="6">
          <Label Text="Клиенты не найдены" FontAttributes="Bold" TextColor="{StaticResource MutedTextColor}"/>
          <Label Text="Измените запрос, фильтры или добавьте клиента" FontSize="12" TextColor="{StaticResource MutedTextColor}"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>
    </CollectionView>
  </Grid>
</ContentPage>
